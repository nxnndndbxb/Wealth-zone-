
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Zone | Digital Wealth Platform</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- [V16] Golden Star / Cleaned & Refined Theme --- */
        :root {
            /* Core Palette (Kept for Dark Background) */
            --background-primary: #04081c;   /* Deeper, richer space blue */
            --background-secondary: #0c1232; /* Richer, lighter space blue for surfaces */
            --text-primary: #f0f8ff;         /* Star White */
            --text-secondary: rgba(240, 248, 255, 0.7); /* Faded starlight */
            
            /* Accents (GOLDEN) */
            --primary-accent: #FFC300;       /* Rich Gold */
            --secondary-accent: #B8860B;     /* Dark Golden Rod */
            --tertiary-accent: #FFEC80;      /* Light Gold Highlight */
            --text-on-accent: #000000;       /* Text color for dark/vibrant buttons (changed to black for gold) */
            
            /* Functional Colors */
            --success-color: #10b981;        /* Emerald Green (Keep for positive TX) */
            --danger-color: #ef4444;         /* Bright Red */
            --warning-color: #f59e0b;        /* Amber Orange (Used for timers) */
            
            /* Surface & Layering (Refined Glassmorphism) */
            --surface-bg: rgba(18, 24, 46, 0.65); /* Translucent Frosted Indigo Glass */
            --surface-bg-darker: rgba(0, 0, 0, 0.3); /* Darker surface for contrast */
            --surface-border: rgba(255, 195, 0, 0.25); /* Faint Gold */
            --surface-highlight: rgba(255, 195, 0, 0.15);
            --shadow-glow: 0 0 20px rgba(255, 195, 0, 0.4);
            --shadow-panel: 0 10px 40px rgba(0, 0, 0, 0.6);
            
            /* General */
            --font-family: 'Poppins', sans-serif;
            --border-radius: 28px;
            --transition-speed: 0.4s;
            --member-color: #4287f5; /* Blue color for members */
            
            /* [NEW] Auth-Specific Variables for High-Security Look */
            --auth-panel-radius: 10px 40px 10px 40px; /* Asymmetric Bevel */
            --auth-input-radius: 8px; /* Sharper input corners */
            --auth-glow: 0 0 10px rgba(255, 195, 0, 0.8), 0 0 20px rgba(255, 195, 0, 0.5);
            --auth-shadow-dark: 0 15px 50px rgba(0, 0, 0, 0.9);
        }

        /* --- General & Body Styling --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-family);
            background-color: transparent; 
            color: var(--text-primary);
            padding-bottom: 120px;
            overflow-x: hidden;
            position: relative;
        }
        
        body.landing-visible { padding-bottom: 0; }
        h1, h2, h3, h4 { color: var(--text-primary); }

        /* --- Animated Backgrounds (Modified for Image & Deeper Color) --- */
        #background-effects { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -2; 
            overflow: hidden; 
            /* MODIFICATION 1: NEW BACKGROUND IMAGE */
            background-image: url('https://iili.io/Ky5W6MJ.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: var(--background-primary); 
        }
        .aurora-background { 
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; 
            background: radial-gradient(ellipse at 20% 25%, hsla(40, 100%, 70%, 0.2), transparent 50%), /* Gold Tint */
                        radial-gradient(ellipse at 80% 75%, hsla(271, 80%, 65%, 0.3), transparent 60%); 
            animation: aurora-flow 35s infinite alternate ease-in-out; 
        }
        @keyframes aurora-flow { from { transform: rotate(0deg) scale(1.3); opacity: 0.8;} to { transform: rotate(15deg) scale(1.3); opacity: 1;} }

        /* --- Preloader (Unchanged) --- */
        #preloader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--background-primary); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease; }
        #preloader.hidden { opacity: 0; visibility: hidden; }
        .spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid rgba(255, 195, 0, 0.2); border-top-color: var(--primary-accent); animation: spin-loader 1s linear infinite; }
        @keyframes spin-loader { to { transform: rotate(360deg); } }

        /* --- Custom Logo Styling (MODIFIED FOR CIRCULAR LOGO ONLY) --- */
        .app-logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .logo-image {
            height: 40px; /* Standard height for landing header */
            width: 40px; /* Make width equal to height */
            object-fit: cover; /* Ensure it covers the circle */
            border-radius: 50%; /* Make it circular */
            border: 2px solid var(--primary-accent); /* Subtle border */
            transition: all 0.3s ease;
        }
        .app-header .app-logo-link .logo-image {
            height: 35px; /* Slightly smaller in app header */
            width: 35px;
        }
        .logo-name {
            display: none; /* HIDE THE TEXT */
        }
        /* End Custom Logo Styling */

        /* --- [NEW] Landing Page Styles (Kept as is) --- */
        #landing-page-container { display: block; width: 100%; overflow-x: hidden; padding: 0 20px; }
        .landing-header { position: fixed; top: 0; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; z-index: 1500; background: transparent; transition: background 0.3s ease, box-shadow 0.3s ease; }
        .landing-header.scrolled { background: var(--background-primary); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 5px 25px rgba(0,0,0,0.7); }
        .landing-hero { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 100px 0; }
        .landing-hero h1 { 
            font-size: clamp(2.5rem, 6vw, 5rem); 
            font-weight: 900; 
            line-height: 1.1; 
            margin-bottom: 25px; 
            background: linear-gradient(90deg, var(--text-primary) 20%, var(--primary-accent) 50%, var(--secondary-accent) 80%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            animation: text-glow-v2 6s ease-in-out infinite alternate; 
            text-shadow: 0 0 15px rgba(255, 195, 0, 0.5);
        }
        @keyframes text-glow-v2 { 
            0% { filter: brightness(1.0); text-shadow: 0 0 10px rgba(255, 195, 0, 0.4); } 
            100% { filter: brightness(1.2); text-shadow: 0 0 25px rgba(255, 195, 0, 0.8), 0 0 40px rgba(184, 134, 11, 0.4); } 
        }
        .landing-hero p { font-size: clamp(1rem, 2.5vw, 1.3rem); color: var(--text-secondary); max-width: 800px; margin-bottom: 50px; line-height: 1.7; }
        .enter-app-btn { padding: 20px 40px; font-size: 1.2em; }
        .scroll-down-indicator { position: absolute; bottom: 40px; font-size: 1.5em; color: var(--primary-accent); animation: bounce-indicator 2s infinite; opacity: 0.8; }
        .scroll-down-indicator i { display: block; }
        @keyframes bounce-indicator { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-15px); } 60% { transform: translateY(-8px); } }
        .landing-section { padding: 120px 0; max-width: 1200px; margin: 0 auto; opacity: 0; transform: translateY(50px); transition: opacity 1s cubic-bezier(0.165, 0.84, 0.44, 1), transform 1s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .landing-section.visible { opacity: 1; transform: translateY(0); }
        .landing-section-header { text-align: center; margin-bottom: 70px; }
        .landing-section-header h2 { font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 800; margin-bottom: 15px; background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .landing-section-header p { font-size: 1.1em; color: var(--text-secondary); max-width: 700px; margin: 0 auto; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .feature-card { 
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            border-radius: var(--border-radius); 
            padding: 40px; 
            backdrop-filter: blur(18px); 
            -webkit-backdrop-filter: blur(18px); 
            text-align: center; 
            transition: all var(--transition-speed) cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: var(--shadow-panel);
        }
        .feature-card:hover { 
            transform: translateY(-12px); 
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8), var(--shadow-glow); 
            border-color: var(--primary-accent); 
        }
        .feature-icon { 
            font-size: 4em; 
            margin-bottom: 25px; 
            background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent));
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 0 15px rgba(255, 195, 0, 0.7);
        }
        .feature-card h3 { font-size: 1.8em; font-weight: 700; margin-bottom: 15px; }
        .feature-card p { color: var(--text-secondary); line-height: 1.8; }
        .feature-card .highlight { 
            display: inline-block; 
            margin-top: 25px; 
            padding: 12px 25px; 
            background: var(--surface-highlight); 
            border: 1px solid var(--surface-border); 
            border-radius: 18px; 
            font-weight: 600; 
            color: var(--primary-accent);
            text-shadow: 0 0 5px rgba(255, 195, 0, 0.5);
            font-size: 0.95em;
        }

        /* --- Main App Containers & Page Transitions (Kept as is) --- */
        #app-container {
            display: none; /* Hidden by default, shown after successful login */
        }
        #app-container.active {
            display: block;
        }
        .page { 
            display: none; 
            padding: 25px 20px; 
            padding-top: 95px; /* Adjusted for new fixed app-header */
            padding-bottom: 120px; /* Space for bottom-nav */
            animation: pageFadeIn 0.8s cubic-bezier(0.165, 0.84, 0.44, 1); 
            min-height: calc(100vh - 120px); 
            max-width: 1200px; /* Increased max-width for better network view */
            margin: 0 auto; 
        }
        .page.active { display: block; }
        @keyframes pageFadeIn { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .page-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 30px; 
            margin-top: -30px; /* Pull up to account for the overall page padding */
        }
        .page-header .back-btn { background: none; border: none; font-size: 1.5em; color: var(--primary-accent); cursor: pointer; margin-right: 15px; transition: transform 0.2s ease; }
        .page-header .back-btn:hover { transform: translateX(-5px); }
        .page-header h3 { flex-grow: 1; font-weight: 700; font-size: 1.8em; color: var(--text-primary); }

        /* --- New App Header for Menu/Sidebar (Kept as is) --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: none; /* Hidden by default, shown on login */
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            z-index: 1050; /* Above bottom-nav (1000) and telegram-fab (1001) */
            background: var(--background-primary);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 3px 15px rgba(0,0,0,0.6);
            height: 70px; /* Fixed height for consistency */
        }
        /* App header logo specific scaling */
        .app-header .logo-text .logo-image {
            height: 35px; 
            width: 35px;
        }
        .app-header .logo-text .logo-name {
            display: none; 
        }
        .menu-btn {
            background: var(--background-secondary);
            border: none;
            color: var(--text-primary);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 1px solid var(--surface-border);
        }
        .menu-btn:hover {
            background: var(--surface-highlight);
            color: var(--primary-accent);
            transform: scale(1.05);
        }

        /* --- Sliding Sidebar/Menu (Kept as is) --- */
        #app-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 300px;
            max-width: 80vw;
            background: var(--surface-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 2px solid var(--surface-border);
            z-index: 2500;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding: 20px;
            padding-top: 90px;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }
        #app-sidebar.active {
            transform: translateX(0);
        }
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2400;
            display: none;
        }
        #app-sidebar.active ~ #sidebar-overlay {
            display: block;
        }
        .sidebar-user-info {
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--surface-border);
        }
        .sidebar-action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-action-list li {
            margin-bottom: 10px;
        }
        .sidebar-action-list button {
            width: 100%;
            display: flex;
            align-items: center;
            background: var(--background-secondary);
            border: none;
            border-radius: 18px;
            padding: 15px 20px;
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }
        .sidebar-action-list button:hover {
            background: var(--surface-highlight);
            color: var(--primary-accent);
            transform: translateX(5px);
        }
        .sidebar-action-list button i {
            font-size: 1.5em;
            width: 30px;
            margin-right: 15px;
        }
        .sidebar-action-list button.logout-btn i { color: var(--danger-color); }
        .sidebar-action-list button.history-btn i { color: var(--member-color); } /* NEW History Icon Color */
        .sidebar-action-list button.nft-btn i { color: var(--primary-accent); }
        .sidebar-action-list button.sell-products-btn i { color: var(--secondary-accent); }
        .sidebar-action-list button.free-mining-btn i { color: var(--success-color); }
        .sidebar-action-list button.about-btn i { color: var(--tertiary-accent); }
        .sidebar-action-list button.security-btn i { color: var(--primary-accent); }

        /* --- Content Panel Component (High-Quality Glassmorphism) - Kept for general app content --- */
        .content-panel { 
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            border-radius: var(--border-radius); 
            padding: 30px; 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            box-shadow: var(--shadow-panel); 
            margin-bottom: 25px; 
            position: relative; 
            overflow: hidden; 
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; 
        }
        .content-panel:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.7), var(--shadow-glow); 
        }
        .content-panel h3 { 
            font-weight: 700; 
            font-size: 1.6em; 
            background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--surface-border); 
        }

        /* --- [HIGH SECURITY LOOK] Auth Pages --- */
        #auth-container { display: none; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        #auth-container.active { display: flex; }
        .auth-form { width: 100%; max-width: 450px; }
        
        /* OVERRIDE: High Security Panel Style */
        .auth-form .content-panel {
            /* NEW SECURITY LOOK STYLES: Angular, Vault-like */
            border-radius: var(--auth-panel-radius); /* Asymmetric Bevel */
            border: 2px solid var(--primary-accent); /* Stronger Border */
            box-shadow: var(--auth-shadow-dark); 
            background: rgba(4, 8, 28, 0.85); /* Less translucent, more vault-like */
            backdrop-filter: blur(5px); /* Reduce blur */
            -webkit-backdrop-filter: blur(5px);
            padding: 40px; /* Increase padding for a bolder feel */
            transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .auth-form .content-panel:hover {
            transform: translateY(-5px); 
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.9), var(--auth-glow);
        }

        /* OVERRIDE: Icon Glow */
        .auth-icon { 
            font-size: 6.5em; 
            text-shadow: 0 0 40px rgba(255, 195, 0, 1), 0 0 80px rgba(255, 195, 0, 0.5); /* Super strong glow */
            margin-bottom: 40px; 
            animation: auth-icon-float 6s ease-in-out infinite, pulse-glow-strong 1.5s infinite alternate; 
            background: linear-gradient(45deg, var(--tertiary-accent), var(--primary-accent));
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        @keyframes pulse-glow-strong {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.05); opacity: 1; }
        }
        @keyframes auth-icon-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        /* OVERRIDE: Header/Title (Changed to center the auth title) */
        .auth-form h2 { 
            text-align: center; /* ALIGNMENT CHANGE: Center the header/title */
            font-weight: 800; 
            font-size: 3.5em; /* Bigger Title */
            margin-bottom: 40px; /* More space */
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary-accent);
            background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent)); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5); 
        }

        /* OVERRIDE: Input Fields (MODIFIED for icon swap) */
        .input-group { position: relative; margin-bottom: 30px; }
        /* Static Icon (Lock/Envelope) - MOVED TO RIGHT */
        .input-group i.fa-solid { 
            position: absolute; 
            right: 25px; /* MOVED TO RIGHT */
            left: auto;  /* Ensure it's not fighting 'left: 25px' */
            top: 50%; transform: translateY(-50%); 
            color: var(--text-secondary); transition: color var(--transition-speed) ease; 
            font-size: 1.2em;
            /* Ensure the toggle doesn't inherit these if it is a .fa-solid */
        }
        /* Password Toggle Icon - MOVED TO LEFT */
        .input-group .toggle-password { 
            position: absolute; /* Re-add to ensure proper positioning */
            left: 25px; /* MOVED TO LEFT */
            right: auto; 
            top: 50%; transform: translateY(-50%); /* Re-add for centering */
            cursor: pointer; color: var(--text-secondary); 
            transition: color 0.3s ease; 
            z-index: 2; /* Ensure it's above the input text */
        }
        .input-group input, .modal-content select { 
            /* Changed to accommodate static icon on RIGHT (default) */
            width: 100%; 
            padding: 22px 60px 22px 20px; /* Increased right padding for static icon */
            border: 2px solid var(--surface-border); 
            border-radius: var(--auth-input-radius); 
            background-color: var(--background-secondary); 
            color: var(--text-primary); 
            font-family: var(--font-family); 
            font-size: 1em; 
            transition: all var(--transition-speed) ease; 
        }
        .input-group input[type="password"] {
             /* Added left padding for the toggle icon (now on the left) */
             padding-left: 60px; 
             padding-right: 60px; /* Keep right padding for the static icon */
        }
        /* Make sure other inputs also have the correct padding */
        .input-group input:not([type="password"]) {
             padding-left: 20px; /* No toggle icon on the left */
        }
        .input-group input::placeholder { color: var(--text-secondary); opacity: 0.8; }
        .input-group input:focus { 
            /* System Scan/Access Look */
            outline: none; 
            border-color: var(--primary-accent); 
            box-shadow: 0 0 30px rgba(255, 195, 0, 0.8), inset 0 0 5px rgba(255, 195, 0, 0.4); /* Inset for depth */
            background-color: var(--background-primary); 
        }
        .input-group input:focus ~ i.fa-solid { color: var(--primary-accent); }
        
        /* OVERRIDE: Buttons (Kept as is) */
        .btn { 
            /* Angular/Geometric Button */
            display: inline-flex; justify-content: center; align-items: center; 
            padding: 22px; /* Bigger button */
            border: none; 
            border-radius: 12px 0 18px 0; /* Asymmetric, angular look */
            color: var(--text-on-accent); 
            background: linear-gradient(90deg, #B8860B, #FFC300, #B8860B); /* Horizontal scan effect gradient */
            background-size: 300% auto;
            font-size: 1.2em; /* Bigger text */
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); 
            position: relative; overflow: hidden; 
            box-shadow: 0 8px 30px -8px rgba(255, 195, 0, 0.5); 
            text-transform: uppercase; letter-spacing: 1px; text-decoration: none; width: auto; 
            border: 2px solid var(--tertiary-accent);
        }
        .btn.full-width { width: 100%; }
        .btn:hover:not(:disabled) { 
            /* Faster, more aggressive hover */
            transform: translateY(-5px) scale(1.01); 
            box-shadow: 0 15px 40px -8px rgba(255, 195, 0, 0.8), var(--auth-glow); 
            background-position: right center; 
        }
        /* End High Security Look Overrides */


        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(0); box-shadow: none; background: var(--background-secondary); border: 2px solid var(--surface-border); }
        .btn .btn-text { transition: opacity 0.2s ease; }
        .btn .spinner-sm { position: absolute; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.3); border-top-color: var(--text-on-accent); border-radius: 50%; animation: spin-loader 0.8s linear infinite; opacity: 0; transition: opacity 0.2s ease; }
        .btn.loading .btn-text { opacity: 0; }
        .btn.loading .spinner-sm { opacity: 1; }
        .auth-switch { text-align: center; margin-top: 25px; color: var(--text-secondary); }
        .auth-switch a { color: var(--primary-accent); text-decoration: none; font-weight: 600; transition: color 0.3s ease; }
        .auth-switch a:hover { color: var(--text-primary); }
        
        /* MODIFIED Recharge/Withdrawal Button Styles (Kept as is) */
        .wallet-actions { 
            display: flex; 
            flex-direction: column; /* Stack vertically on small screens */
            gap: 15px; 
            margin-top: 25px; 
        }
        .wallet-actions .btn { 
            flex: 1; 
            padding: 15px 20px; 
            font-size: 1.1em; 
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 14px; 
            border: none; /* Remove angular border for internal buttons */
        }
        .btn-buy { background: linear-gradient(45deg, var(--success-color), #4ade80); color: white; box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        .btn-sell { background: linear-gradient(45deg, var(--danger-color), #f87171); color: white; box-shadow: 0 0 25px rgba(239, 68, 68, 0.5); }
        
        @media (min-width: 650px) {
            .wallet-actions {
                flex-direction: row;
                gap: 20px;
            }
        }
        /* END MODIFIED Button Styles */

        /* --- Bottom Navigation Bar (Floating Dock) - Kept as is) --- */
        .bottom-nav { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 40px); max-width: 500px; height: 85px; 
            background: var(--surface-bg); 
            border: 1px solid var(--surface-border); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); 
            display: flex; justify-content: space-around; align-items: center; 
            border-radius: calc(var(--border-radius) + 10px); 
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), var(--shadow-glow); 
            z-index: 1000; 
            padding: 0 10px;
        }
        .nav-btn { 
            background: none; border: none; color: var(--text-secondary); 
            display: flex; flex-direction: column; align-items: center; 
            font-size: 0.8em; font-weight: 500; cursor: pointer; 
            transition: all var(--transition-speed) ease; position: relative; 
            padding: 8px 5px; width: 70px; 
        }
        .nav-btn i { font-size: 1.8em; margin-bottom: 5px; }
        .nav-btn.active { color: var(--text-primary); transform: translateY(-8px); }
        .nav-btn.active i { 
            color: var(--primary-accent); 
            text-shadow: 0 0 10px var(--primary-accent);
        }
        .nav-btn::before { 
            content: ''; position: absolute; top: 0; 
            width: 80%; height: 3px; 
            background: linear-gradient(90deg, transparent, var(--primary-accent), transparent);
            border-radius: 0 0 5px 5px;
            transform: scaleX(0); 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 0 10px var(--primary-accent);
        }
        .nav-btn.active::before { transform: scaleX(1); }

        /* --- Draggable Floating Telegram Button - Kept as is --- */
        .telegram-fab { 
            position: fixed; bottom: 120px; right: 25px; 
            width: 65px; height: 65px; 
            background: linear-gradient(45deg, #FFC300, #B8860B); /* Golden gradient */
            color: var(--background-primary); border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2em; text-decoration: none; 
            box-shadow: 0 8px 30px rgba(255, 195, 0, 0.4), 0 0 15px rgba(255, 195, 0, 0.6); 
            z-index: 1001; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            user-select: none; -webkit-user-select: none; cursor: grab; 
            transform: scale(0); 
            animation: fab-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 1.5s forwards; 
        }
        .telegram-fab.dragging { cursor: grabbing; transition: none; box-shadow: 0 12px 35px rgba(255, 195, 0, 0.6); }
        .telegram-fab:hover:not(.dragging) { transform: scale(1.1); box-shadow: 0 15px 40px rgba(255, 195, 0, 0.8); }
        @keyframes fab-pop-in { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- Home Page (Modified for Carousel) --- */
        .header-welcome { text-align: center; margin-bottom: 30px; }
        .header-welcome h2 { font-size: 2.5em; font-weight: 800; line-height: 1.2; color: var(--text-primary)}
        .header-welcome p { color: var(--text-secondary); font-weight: 300; font-size: 1.1em; }
        
        /* NEW: Home Page Carousel Styles */
        #home-carousel-container {
            width: 100%;
            max-width: 600px; /* Define a reasonable max width for the rectangle */
            margin: 0 auto 30px;
            overflow: hidden;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 20px rgba(255, 195, 0, 0.5);
            position: relative;
            aspect-ratio: 16 / 9; /* Define a rectangular aspect ratio */
        }

        #home-carousel {
            display: flex;
            height: 100%;
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .carousel-slide {
            min-width: 100%; /* Each slide takes 100% of the visible container width */
            height: 100%;
            object-fit: cover; 
        }
        /* END NEW Carousel Styles */

        /* --- General Stats, Trade, Wallet, etc. (Kept as is) --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card { 
            background: var(--background-secondary); 
            border-radius: 20px; padding: 25px; text-align: center; 
            border: 1px solid var(--surface-border); 
            transition: all var(--transition-speed) ease; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .stat-card:hover { border-color: var(--primary-accent); transform: scale(1.03) translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.6), 0 0 15px rgba(255, 195, 0, 0.4); background: var(--surface-bg);}
        .stat-card .label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; color: var(--text-primary); }
        .balance-display { text-align: center; margin-bottom: 30px; }
        .balance-display .amount { 
            font-size: 4.5em; font-weight: 800; line-height: 1.1; 
            background: linear-gradient(90deg, var(--text-primary), var(--primary-accent)); 
            -webkit-background-clip: text; background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 20px rgba(255, 195, 0, 0.3); 
        }
        .balance-display .currency { color: var(--text-secondary); font-weight: 400; font-size: 1.2em; margin-left: 5px; }
        .balance-on-hold { text-align: center; color: var(--warning-color); font-size: 1em; margin-top: -15px; margin-bottom: 30px; font-weight: 600; }
        .trade-form input, .modal-content select { padding: 20px; }
        
        /* --- Ranking Page Styles (Revamped Style) --- */
        #ranking-page h3 { background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .ranking-item { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background-color: var(--background-secondary); border-radius: 14px; border-left: 5px solid var(--primary-accent); transition: background-color 0.3s ease, transform 0.3s ease; }
        .ranking-item:hover { background-color: var(--surface-bg-darker); transform: translateX(3px); }
        .ranking-item .rank-num { 
            font-size: 1.8em; /* Larger number */
            font-weight: 800; 
            width: 15%; 
            text-align: center; 
            color: var(--primary-accent); 
        }
        .ranking-item .rank-num.top-3 { 
            color: var(--tertiary-accent); 
            font-size: 2.2em; 
            text-shadow: 0 0 15px var(--tertiary-accent);
        }
        .ranking-item .user-info { width: 40%; } /* Adjusted width */
        .ranking-item .user-info .username { font-weight: 600; font-size: 1.1em; color: var(--text-primary); }
        .ranking-item .user-info .uid { font-size: 0.8em; color: var(--text-secondary); }
        .ranking-item .net-worth { font-size: 1.4em; font-weight: 700; width: 45%; text-align: right; color: var(--success-color); }
        .ranking-header-row { font-size: 0.9em; } /* Adjusted size */
        /* --- END Ranking Page Styles --- */

        /* --- History List & General Styles (Kept as is) --- */
        @keyframes reward-pulse-green { 0% { text-shadow: 0 0 5px rgba(16, 185, 129, 0.3); } 50% { text-shadow: 0 0 20px rgba(16, 185, 129, 0.7); } 100% { text-shadow: 0 0 5px rgba(16, 185, 129, 0.3); } }
        .history-list { list-style-type: none; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .transaction-item { display: flex; align-items: center; padding: 18px; margin-bottom: 12px; background-color: var(--background-secondary); border-radius: 16px; border-left: 5px solid var(--text-secondary); transition: background-color 0.3s ease, transform 0.3s ease; }
        .transaction-item:hover { background-color: var(--surface-bg-darker); transform: translateX(3px); }
        /* Transaction colors remain distinct */
        .transaction-item.buy, .transaction-item.deposit, .transaction-item.plan_profit, .transaction-item.invite_bonus, .transaction-item.nft_profit { border-left-color: var(--success-color); }
        .transaction-item.sell, .transaction-item.withdrawal, .transaction-item.nft_purchase, .transaction-item.plan_invest { border-left-color: var(--danger-color); }
        .transaction-item.pending { border-left-color: var(--warning-color); opacity: 0.9; } /* Slightly less opacity for clarity */
        .transaction-item.rejected { border-left-color: var(--danger-color); opacity: 0.7; } /* Faded red for rejected */
        .transaction-item.approved { border-left-color: var(--success-color); opacity: 1.0; } /* Strong green for approved/completed */
        .transaction-item.bonus { border-left-color: var(--primary-accent); }
        .transaction-item .icon { font-size: 1.8em; width: 40px; text-align: center; margin-right: 15px; }
        .transaction-item.buy .icon, .transaction-item.deposit .icon, .transaction-item.plan_profit .icon, .transaction-item.invite_bonus .icon, .transaction-item.nft_profit .icon { color: var(--success-color); }
        .transaction-item.sell .icon, .transaction-item.withdrawal .icon, .transaction-item.nft_purchase .icon, .transaction-item.plan_invest .icon { color: var(--danger-color); }
        .transaction-item.bonus .icon { color: var(--primary-accent); }
        .transaction-item.pending .icon { color: var(--warning-color); }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .type { font-weight: 600; text-transform: capitalize; color: var(--text-primary); font-size: 1.1em;}
        .transaction-item .date { font-size: 0.85em; color: var(--text-secondary); }
        .transaction-item .amount { font-size: 1.2em; font-weight: 700; text-align: right; color: var(--text-primary); }

        /* --- Beautiful Profile Page (Kept as is) --- */
        .profile-header { text-align: center; margin-bottom: 30px; }
        .profile-avatar { 
            width: 110px; height: 110px; border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary-accent), var(--secondary-accent)); 
            display: flex; justify-content: center; align-items: center; 
            margin: 0 auto 20px; 
            box-shadow: 0 0 30px rgba(255, 195, 0, 0.7), 0 0 50px rgba(184, 134, 11, 0.4); 
            border: 4px solid var(--background-primary);
        }
        .profile-avatar i { font-size: 4em; color: var(--background-primary); }
        .profile-header h2 { font-size: 2em; font-weight: 800; margin-bottom: 5px; }
        .profile-header p { color: var(--text-secondary); font-size: 1em; font-family: 'Courier New', monospace; }
        .profile-actions-grid { display: none; } /* Removed from display */

        /* --- Invite Page (Styling for new elements) --- */
        .invite-box { text-align: center; }
        .invite-box .icon { font-size: 5em; margin: 20px 0; color: var(--primary-accent); text-shadow: 0 0 25px rgba(255, 195, 0, 0.6);}
        .invite-box p { color: var(--text-secondary); line-height: 1.8; margin-bottom: 25px; font-size: 1.05em;}
        
        .bonus-display { text-align: center; margin-bottom: 30px; }
        .bonus-display .label { text-transform: uppercase; letter-spacing: 1px; font-size: 1em; color: var(--text-secondary); margin-bottom: 10px; }
        .bonus-display .amount { font-size: 3.5em; font-weight: 800; color: var(--success-color); animation: reward-pulse-green 2s infinite; }
        
        /* --- [NEW] Hexagon Network Styles --- */
        :root {
            --hex-bg-color: #0c0a1a;
            --hex-font-color: #e0e0e0;
            --hex-gold-color-1: #ffd700;
            --hex-gold-color-2: #f0c300;
            --hex-blue-color-1: #00b4d8;
            --hex-blue-color-2: #0077b6;
            --hex-connector-color: rgba(0, 180, 216, 0.25);
            --hex-level-label-color: rgba(255, 255, 255, 0.4);
            
            --hex-size-you: 140px;
            --hex-size-user: 80px;
        }
        #invite-page .content-panel {
            overflow: visible; /* Allow tooltips to show outside the panel bounds */
        }
        .network-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px 20px 50px;
            width: 100%;
        }

        /* Hexagon Base Styles */
        .hexagon {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .hexagon:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .hexagon-inner {
            font-size: 0.8rem;
            font-weight: 600;
            word-break: break-all;
            padding: 0 5px;
        }
        .hexagon-inner i {
            display: block;
            margin-bottom: 5px;
        }

        /* Specific Hexagon Styles (YOU vs USER) */
        .you-node {
            width: var(--hex-size-you);
            height: calc(var(--hex-size-you) * 1.1547); /* Maintain aspect ratio */
            background: linear-gradient(145deg, var(--hex-gold-color-1), #B8860B);
            color: #2b2b2b;
            box-shadow: 0 0 30px var(--hex-gold-color-1);
            cursor: default;
        }

        .you-node .hexagon-inner i {
            font-size: 2.5rem;
        }
         .you-node .hexagon-inner span {
            font-size: 1.5rem;
        }

        .user-node {
            width: var(--hex-size-user);
            height: calc(var(--hex-size-user) * 1.1547);
            background: linear-gradient(145deg, var(--hex-blue-color-1), var(--hex-blue-color-2));
            color: #fff;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 180, 216, 0.5);
        }

        .user-node .hexagon-inner i {
            font-size: 1.5rem;
        }

        /* Network Levels & Connections */
        .level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            position: relative;
            padding: 30px 0;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        /* Connector Lines */
        .user-node::before {
            content: '';
            position: absolute;
            bottom: 99%; /* Start from the top tip of the hexagon */
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 50px; /* Height of the line connecting levels */
            background: var(--hex-connector-color);
            z-index: -1;
        }
        
        /* Level Labels */
        .level::before {
            content: 'Level ' attr(data-level);
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Roboto Mono', monospace;
            color: var(--hex-level-label-color);
            font-size: 0.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Tooltip for User Info */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a1a2e;
            color: var(--hex-gold-color-1);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--hex-gold-color-2);
            font-size: 0.9rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Invite Link Display & Copy Button */
        .invite-link-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
        }
        .network-code {
            font-family: 'Roboto Mono', monospace;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: var(--primary-accent);
            word-break: break-all;
            text-align: center;
        }
        .copy-btn-new {
            background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent));
            color: var(--text-on-accent);
            border: none;
            padding: 12px 25px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            border: 1px solid var(--primary-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .copy-btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.7);
        }
        .copy-btn-new:active {
            transform: translateY(0);
        }
        .copy-btn-new i {
            margin-right: 8px;
        }
        /* --- [END] Hexagon Network Styles --- */
        
        /* --- NFT Page Styles (Kept as is) --- */
        #nft-page h3 { background: linear-gradient(90deg, var(--primary-accent), var(--text-primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .nft-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .nft-card { 
            background: var(--surface-bg); border: 2px solid var(--surface-border); border-radius: 20px; 
            padding: 30px; text-align: center; transition: all var(--transition-speed) ease; 
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nft-card:hover { transform: translateY(-10px); box-shadow: 0 15px 50px rgba(0,0,0,0.6); }
        .nft-card .nft-visual { 
            width: 130px; height: 130px; margin: 0 auto 25px; 
            border-radius: 25px; display: flex; justify-content: center; align-items: center; 
            font-size: 4.5em; 
            border: 4px solid var(--background-primary);
        }
        .nft-card h4 { font-size: 1.6em; font-weight: 700; margin-bottom: 10px; }
        .nft-card .price-range { font-size: 1.2em; font-weight: 500; color: var(--warning-color); margin-bottom: 25px; }
        .nft-details { list-style-type: none; margin-bottom: 25px; text-align: left; background-color: var(--surface-bg-darker); padding: 20px; border-radius: 16px; }
        .nft-details li { padding: 10px 0; display: flex; justify-content: space-between; border-bottom: 1px dashed var(--background-secondary); font-size: 1em; }
        .nft-details li:last-child { border-bottom: none; }
        .nft-details li span:first-child { color: var(--text-secondary); }
        .nft-details li span:last-child { font-weight: 600; color: var(--primary-accent); }
        .nft-card .btn { margin-top: 20px; }
        /* NFT Card Specific Colors */
        #nft-bronze { border-color: #cd7f32; }
        #nft-bronze .nft-visual { background: linear-gradient(45deg, #a96628, #cd7f32); box-shadow: 0 0 25px #cd7f32; color: #fff; }
        #nft-silver { border-color: #c0c0c0; }
        #nft-silver .nft-visual { background: linear-gradient(45deg, #a0a0a0, #c0c0c0); box-shadow: 0 0 25px #c0c0c0; color: var(--background-primary); }
        #nft-gold { border-color: #FFC300; }
        #nft-gold .nft-visual { background: linear-gradient(45deg, #e4a11b, #FFC300); box-shadow: 0 0 25px #FFC300; color: var(--background-primary); }
        
        /* --- Plan Card Styling (Kept as is) --- */
        .plan-series-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Single column for two plans */
            gap: 20px; 
        }
        
        .plan-card {
             background: var(--surface-bg); border: 2px solid var(--surface-border); border-radius: 20px; 
            padding: 25px; 
            text-align: center; transition: all var(--transition-speed) ease; 
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-color: var(--primary-accent);
        }
        .plan-card:hover { transform: translateY(-10px); box-shadow: 0 15px 50px rgba(0,0,0,0.6); border-color: var(--primary-accent); }
        .plan-card h4 { font-size: 1.4em; font-weight: 700; margin-bottom: 8px; }
        .plan-card .plan-price { font-size: 1em; font-weight: 500; color: var(--warning-color); margin-bottom: 15px; }
        .plan-card .plan-visual { 
            width: 70px; height: 70px; margin: 0 auto 20px; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 2em; 
            background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent));
            color: var(--background-primary);
            box-shadow: 0 0 15px var(--primary-accent);
        }
        .plan-card .nft-details li { padding: 8px 0; font-size: 0.9em; }

        /* --- My NFTs Page Styles (Kept as is) --- */
        .my-nft-card { background: var(--surface-bg-darker); border-radius: 20px; padding: 25px; margin-bottom: 20px; border-left: 6px solid; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .my-nft-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .my-nft-card-header h4 { margin: 0; font-size: 1.4em; font-weight: 700; }
        .my-nft-card-header .investment { font-size: 1.2em; font-weight: 700; }
        .nft-profit-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; text-align: center; }
        .nft-profit-details .label { font-size: 0.9em; color: var(--text-secondary); }
        .nft-profit-details .value { font-size: 1.3em; font-weight: 700; color: var(--text-primary); }
        .nft-timer { font-weight: 600; color: var(--warning-color); text-align: center; margin-bottom: 20px; font-size: 1.1em; }
        .nft-progress-bar { width: 100%; height: 12px; background-color: var(--background-secondary); border-radius: 6px; overflow: hidden; margin-top: 10px; }
        .nft-progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary-accent), var(--success-color)); border-radius: 6px; transition: width 0.5s ease; }
        .nft-progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary-accent), var(--success-color)); border-radius: 6px; transition: width 0.5s ease; }
        .my-nft-card .btn { margin-top: 20px; }

        /* --- Modals, Toast, etc. (Kept as is) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(4, 8, 28, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            z-index: 2000; display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: opacity var(--transition-speed) ease; 
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { 
            width: calc(100% - 40px); max-width: 450px; 
            transform: scale(0.9) translateY(50px); 
            transition: transform var(--transition-speed) cubic-bezier(0.165, 0.84, 0.44, 1);
            max-height: 90vh; 
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        /* Modal content panel inherits from the general .content-panel (rounded) not the auth panel (angular) */
        .modal-content.content-panel { 
            border-radius: var(--border-radius); 
            border: 1px solid var(--surface-border);
            box-shadow: var(--shadow-panel);
            background: var(--surface-bg);
            padding: 30px;
        }
        .option-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; background-color: var(--surface-bg-darker); padding: 8px; border-radius: 20px; }
        .option-btn { padding: 15px; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .option-btn.active { background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent)); color: var(--text-on-accent); box-shadow: 0 5px 15px rgba(255, 195, 0, 0.4); }
        .option-btn:hover { background: var(--surface-highlight); color: var(--primary-accent); }
        .address-box { 
            background-color: var(--surface-bg-darker); 
            padding: 20px; border-radius: 16px; margin-bottom: 20px; 
            word-wrap: break-word; display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid var(--surface-border); cursor: pointer; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease; 
        }
        .address-box:hover { border-color: var(--primary-accent); }
        .address-box.copied { border-color: var(--success-color); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .address-box .address { flex: 1; margin-right: 15px; font-family: 'Courier New', monospace; word-break: break-all; font-size: 0.9em; }
        .copy-btn { background: none; border: none; color: var(--primary-accent); cursor: pointer; font-size: 1.5em; transition: color 0.3s ease, transform 0.3s ease; }
        .copy-btn:hover { color: var(--text-primary); transform: scale(1.1); }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: var(--surface-bg-darker); border: 1px solid var(--surface-border); color: var(--text-primary); width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer; transition: background-color 0.3s ease, transform 0.3s ease; z-index: 10; }
        .modal-close-btn:hover { background-color: rgba(255,255,255,0.1); transform: rotate(90deg); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--surface-bg); border-left: 6px solid var(--primary-accent); border-radius: 14px; padding: 20px 28px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); color: var(--text-primary); margin-bottom: 15px; opacity: 0; transform: translateX(100%); animation: toastIn 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; min-width: 320px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .toast.success { border-left-color: var(--success-color); }
        .toast.danger { border-left-color: var(--danger-color); }
        .toast.info { border-left-color: var(--secondary-accent); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            :root {
                --hex-size-you: 100px;
                --hex-size-user: 60px;
            }
            .level {
                gap: 10px;
            }
            .user-node::before {
                height: 40px;
            }
        }
        @media (max-width: 650px) {
            .plan-series-grid {
                grid-template-columns: 1fr; /* Stack plans on smaller screens */
            }
        }
        @media (max-width: 480px) {
            .content-panel { padding: 25px 20px; }
            .content-panel h3 { margin-bottom: 20px; padding-bottom: 10px; font-size: 1.4em; }
            
            /* Responsive Auth Overrides */
            .auth-form .content-panel { padding: 30px; border-radius: 5px 30px 5px 30px; }
            .auth-form h2 { font-size: 2.5em; text-align: center; margin-bottom: 30px;} 
            .auth-icon { font-size: 5em; margin-bottom: 20px; }
            /* Icon Swap Mobile Adjustment */
            .input-group input, .modal-content select { padding: 18px 55px 18px 20px; } /* Right padding for static icon */
            .input-group input:not([type="password"]) { padding-left: 20px; } /* No toggle, use default left padding */
            .input-group input[type="password"] { padding-left: 55px; padding-right: 55px; } /* Toggle left, Static right */
            .input-group i.fa-solid { left: auto; right: 20px; } /* Static icon right */
            .input-group .toggle-password { left: 20px; right: auto; } /* Toggle icon left */
            /* End Responsive Auth Overrides */

            .balance-display .amount { font-size: 3.5em; }
            .telegram-fab { width: 55px; height: 55px; right: 20px; bottom: 105px; font-size: 1.6em;}
            .profile-actions-grid { gap: 10px; }
            .action-card { padding: 18px; }
            .action-card i { font-size: 2.2em; }
            .action-card span { font-size: 0.9em; }
            .bottom-nav { width: calc(100% - 30px); height: 75px; border-radius: 20px; bottom: 15px; }
            .nav-btn { width: 60px; font-size: 0.7em; }
            .nav-btn i { font-size: 1.6em; }
            .staking-overview { gap: 15px; }

            /* Responsive Ranking Style */
            .ranking-item { padding: 12px; }
            .ranking-item .rank-num { font-size: 1.4em; width: 15%; } 
            .ranking-item .rank-num.top-3 { font-size: 1.8em; }
            .ranking-item .user-info { width: 40%; } 
            .ranking-item .net-worth { font-size: 1.1em; width: 45%; }
            .ranking-header-row { font-size: 0.8em; }
        }
         .fbr-certificate { 
            margin-top: 30px; 
            padding: 25px; 
            border: 3px solid var(--success-color); 
            border-radius: 20px; 
            background: var(--surface-bg-darker);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }
        .fbr-certificate h4 { 
            color: var(--success-color); 
            font-size: 1.5em; 
            margin-bottom: 10px;
        }
        .fbr-certificate p { 
            color: var(--text-secondary); 
            margin: 5px 0;
            font-size: 0.95em;
        }
        .fbr-certificate .seal {
            font-size: 3em;
            color: var(--warning-color);
            opacity: 0.5;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg);
        }

        /* NEW: Enhanced History Page Styles */
        .history-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .history-filter-btn {
            padding: 10px 20px;
            background: var(--background-secondary);
            border: 1px solid var(--surface-border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .history-filter-btn.active {
            background: var(--primary-accent);
            color: var(--text-on-accent);
            border-color: var(--primary-accent);
            box-shadow: 0 0 10px rgba(255, 195, 0, 0.5);
        }
        .history-filter-btn:hover:not(.active) {
            background: var(--surface-highlight);
            color: var(--primary-accent);
        }

        /* NEW: Enhanced Active Plan Display */
        .active-plan-card {
            background: linear-gradient(135deg, var(--surface-bg), var(--background-secondary));
            border: 2px solid var(--primary-accent);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px rgba(255, 195, 0, 0.3);
        }
        .active-plan-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent));
        }
        .active-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .active-plan-title {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-accent);
            text-shadow: 0 0 10px rgba(255, 195, 0, 0.5);
        }
        .active-plan-badge {
            background: var(--primary-accent);
            color: var(--text-on-accent);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .active-plan-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .active-plan-stat {
            text-align: center;
            padding: 15px;
            background: var(--surface-bg-darker);
            border-radius: 15px;
            border: 1px solid var(--surface-border);
        }
        .active-plan-stat .label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .active-plan-stat .value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
        }
        .active-plan-stat .value.profit {
            color: var(--success-color);
        }
        .active-plan-progress {
            margin-top: 15px;
        }
        .active-plan-progress .label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--background-secondary);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-accent), var(--success-color));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

    </style>
</head>
<body class="landing-visible">
    <div id="particles-js"></div>
    <div id="background-effects">
        <div class="aurora-background"></div>
    </div>
    <div id="toast-container"></div>

    <!-- Preloader -->
    <div id="preloader"><div class="spinner"></div></div>
    
    <!-- [NEW] Landing Page Container -->
    <div id="landing-page-container">
        <header class="landing-header" id="landing-header">
            <!-- MODIFICATION 2: NEW Logo Structure - Only Circular Image Visible -->
            <a href="#" class="landing-logo app-logo-link">
                <img src="https://iili.io/Ky5WhCb.png" alt="Wealth Zone Logo" class="logo-image">
                <span class="logo-name">Wealth Zone</span>
            </a>
            <button class="btn enter-app-btn">Enter App</button>
        </header>
        <main class="landing-main">
            <section class="landing-hero">
                <h1>Unlock the Future of Digital Wealth</h1>
                <p>Welcome to Wealth Zone, the next-generation ecosystem where your digital assets work for you. Engage in powerful earning plans, and build your network to maximize your PKR earnings.</p>
                <button class="btn enter-app-btn">Get Started Now</button>
                <div class="scroll-down-indicator">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </section>
            
            <section class="landing-section">
                <div class="landing-section-header">
                    <h2>Smart Earning Plans</h2>
                    <p>Choose from our two exclusive plans designed to maximize your earnings through both direct commissions and daily returns.</p>
                </div>
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-rocket"></i></div>
                        <h3>Basic Plan</h3>
                        <p>Perfect for beginners - get access to invitation rewards and build your network.</p>
                        <div class="highlight">PKR 670 | Invitation Rewards Only</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-chart-line"></i></div>
                        <h3>Pro Earning Plan</h3>
                        <p>Advanced plan with daily 1% non-working income plus invitation rewards.</p>
                        <div class="highlight">PKR 12,500 | 1% Daily + Rewards</div>
                    </div>
                </div>
            </section>

            <section class="landing-section">
                <div class="landing-section-header">
                    <h2>Powerful Network System</h2>
                    <p>Build your community and earn significant commissions. Our multi-level block system rewards you for every new member you bring into the ecosystem.</p>
                </div>
                 <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-cubes"></i></div>
                        <h3>Direct Commission</h3>
                        <p>Earn generous commissions on investments made by anyone you directly invite to the platform.</p>
                        <div class="highlight">Direct Bonus</div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon"><i class="fas fa-link"></i></div>
                        <h3>Network Rewards</h3>
                        <p>Your earnings don't stop at your direct connections. Earn commissions from indirect referrals.</p>
                        <div class="highlight">Multi-Level Rewards</div>
                    </div>
                </div>
            </section>

            <section class="landing-section landing-cta">
                <div class="landing-section-header">
                    <h2>Ready to Join the Revolution?</h2>
                    <p>Your journey towards financial freedom starts here. Create your account in seconds and step into the future of digital wealth.</p>
                </div>
                <button class="btn enter-app-btn">Create My Account</button>
            </section>
        </main>
    </div>

    <!-- Authentication Container (Login/Register) - High Security Look Applied Here -->
    <div id="auth-container">
        <div id="login-page-container" class="auth-form">
            <!-- Login Photo/Icon in Center -->
            <div class="auth-icon"><i class="fas fa-gem"></i></div>
            <div class="content-panel">
                <h2>Access Login</h2>
                <form id="login-form">
                    <div class="input-group">
                        <input type="email" id="login-email" required placeholder="Email Address" autocomplete="email">
                        <i class="fa-solid fa-envelope"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <!-- Toggle Icon (Left) and Static Icon (Right) in CSS -->
                        <input type="password" id="login-password" required placeholder="Security Key" autocomplete="current-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-lock"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width"><span class="btn-text">Login Securely</span><div class="spinner-sm"></div></button>
                </form>
                <p class="auth-switch" style="margin-top: 15px; text-align: right; margin-bottom: 0;">
                    <a href="#" id="show-forgot-password-link">Forgot Password?</a>
                </p>
                <p class="auth-switch">No security profile? <a href="#" id="show-register-link">Create Account</a></p>
            </div>
        </div>
        <div id="register-page-container" class="auth-form" style="display: none;">
            <!-- Register Photo/Icon in Center -->
            <div class="auth-icon"><i class="fas fa-user-astronaut"></i></div>
            <div class="content-panel">
                <h2>Profile Registration</h2>
                <form id="register-form">
                    <div class="input-group">
                        <input type="text" id="register-username" required placeholder="Username" autocomplete="username">
                        <i class="fa-solid fa-user"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="email" id="register-email" required placeholder="Email" autocomplete="email">
                        <i class="fa-solid fa-envelope"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <!-- Toggle Icon (Left) and Static Icon (Right) in CSS -->
                        <input type="password" id="register-password" required placeholder="New Security Key" autocomplete="new-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-lock"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <!-- Toggle Icon (Left) and Static Icon (Right) in CSS -->
                        <input type="password" id="register-repeat-password" required placeholder="Confirm Security Key" autocomplete="new-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-key"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="register-ref-code" placeholder="Invitation Code (Optional)" autocomplete="off">
                        <i class="fa-solid fa-gift"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width"><span class="btn-text">Create My Account</span><div class="spinner-sm"></div></button>
                </form>
                <p class="auth-switch">Already established profile? <a href="#" id="show-login-link">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container"> 
        <!-- New App Header -->
        <header class="app-header" id="app-header">
            <button class="menu-btn" id="menu-toggle-btn"><i class="fas fa-bars"></i></button>
            <!-- MODIFICATION 3: NEW Logo Structure for App Header (Only Circular Image Visible) -->
            <div class="logo-text app-logo-link">
                <img src="https://iili.io/Ky5WhCb.png" alt="Wealth Zone Logo" class="logo-image">
                <span class="logo-name">Wealth Zone</span>
            </div>
            <div style="width: 45px; height: 45px;"></div> <!-- Spacer for balance/icons if needed -->
        </header>

        <!-- Sidebar Overlay (for closing) -->
        <div id="sidebar-overlay"></div>

        <!-- Sliding Sidebar (ADDED History Button) -->
        <aside id="app-sidebar">
            <div class="sidebar-user-info">
                <div class="profile-avatar"><i class="fas fa-user-astronaut"></i></div>
                <h2 id="sidebar-username-display">...</h2>
                <p id="sidebar-email-display" style="font-family: var(--font-family);">...</p>
                <div style="margin-top: 15px;">
                    <div class="stat-card" style="padding: 15px;">
                        <div class="label">User ID</div>
                        <div class="value" id="sidebar-uid-display" style="font-size: 1.1em; font-family: monospace;">...</div>
                    </div>
                </div>
            </div>
            <ul class="sidebar-action-list">
                <!-- NEW: History Button -->
                <li><button class="action-card history-btn" data-page-target="history-page"><i class="fas fa-history"></i><span>History</span></button></li>
                <li><button class="action-card nft-btn" data-page-target="nft-page"><i class="fas fa-gem"></i><span>NFTs</span></button></li>
                <li><button class="action-card sell-products-btn" data-page-target="sell-products-page"><i class="fas fa-store"></i><span>Sell Products</span></button></li>
                <li><button class="action-card free-mining-btn" data-page-target="free-mining-page"><i class="fas fa-bolt-lightning"></i><span>Free Plan</span></button></li>
                <li><button class="action-card about-btn" data-page-target="about-us-page"><i class="fas fa-info-circle"></i><span>About Us</span></button></li>
                <li><button class="action-card security-btn" data-page-target="security-page"><i class="fas fa-shield-halved"></i><span>Security</span></button></li>
                <li><button class="action-card logout-btn" id="sidebar-logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button></li>
            </ul>
        </aside>

        <!-- Draggable Floating Telegram Button -->
        <a href="https://t.me/automining009" target="_blank" class="telegram-fab" id="telegram-fab" title="Contact Support on Telegram">
            <i class="fab fa-telegram"></i>
        </a>

        <!-- Home Page (Dashboard/Plans) -->
        <main id="home-page" class="page active">
            <header class="header-welcome">
                <!-- MODIFICATION: REMOVED PROFILE PIC, ADDED CAROUSEL CONTAINER -->
                <div id="home-carousel-container">
                    <div id="home-carousel" class="carousel-slides">
                        <img src="https://iili.io/KyYBjna.png" alt="Slide 1" class="carousel-slide">
                        <img src="https://iili.io/KyYBwMJ.png" alt="Slide 2" class="carousel-slide">
                        <img src="https://iili.io/KyYBWwF.png" alt="Slide 3" class="carousel-slide">
                    </div>
                </div>
                <!-- END CAROUSEL -->
                <h2 id="welcome-user">Welcome Back!</h2>
                <p>Your gateway to perpetual digital wealth.</p>
            </header>
            
            <!-- User Stats -->
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 30px;">
                <div class="stat-card"><div class="label">Your Wallet (PKR)</div><div class="value" id="home-pkr-balance">PKR 0</div></div>
                <div class="stat-card"><div class="label">Active Plan</div><div class="value" id="home-active-plan">None</div></div>
            </div>

            <!-- NEW: Enhanced Active Plan Display -->
            <div class="active-plan-card" id="active-plan-display" style="display: none;">
                <div class="active-plan-header">
                    <div class="active-plan-title" id="active-plan-name">Pro Earning Plan</div>
                    <div class="active-plan-badge">ACTIVE</div>
                </div>
                <div class="active-plan-stats">
                    <div class="active-plan-stat">
                        <div class="label">Investment</div>
                        <div class="value" id="active-plan-investment">PKR 0</div>
                    </div>
                    <div class="active-plan-stat">
                        <div class="label">Daily Profit</div>
                        <div class="value profit" id="active-plan-daily-profit">PKR 0</div>
                    </div>
                    <div class="active-plan-stat">
                        <div class="label">Accumulated</div>
                        <div class="value profit" id="active-plan-accumulated">PKR 0</div>
                    </div>
                    <div class="active-plan-stat">
                        <div class="label">Next Claim</div>
                        <div class="value" id="active-plan-next-claim">Ready</div>
                    </div>
                </div>
                <div class="active-plan-progress">
                    <div class="label">
                        <span>Profit Progress</span>
                        <span id="active-plan-progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="active-plan-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="wallet-actions" style="margin-top: 25px;">
                    <button class="btn full-width" id="claim-plan-profit-btn" disabled style="flex-grow: 1;">
                        <span class="btn-text"><i class="fas fa-hand-holding-dollar"></i> Claim Profit</span>
                        <div class="spinner-sm"></div>
                    </button>
                </div>
            </div>
            
            <!-- New Plans Section - Always visible for purchase -->
            <div class="content-panel" id="marketing-plans-panel">
                <h3>Smart Earning Plans</h3>
                <p class="info-text" style="margin-bottom: 25px;">Available Balance: <b id="plans-page-pkr-balance">PKR 0</b></p>
                <div id="marketing-plans-container" class="plan-series-grid">
                    <!-- Plans will be populated by JS -->
                </div>
            </div>

        </main>

        <!-- [NEW] Enhanced History Page -->
        <section id="history-page" class="page">
            <div class="page-header">
                <h3>Transaction History</h3>
            </div>
            <div class="content-panel">
                <h3>All System Transactions</h3>
                <p class="info-text" style="margin-bottom: 25px;">Review all deposits, withdrawals, plan, NFT, and referral transactions.</p>
                
                <!-- NEW: History Filters -->
                <div class="history-filters">
                    <button class="history-filter-btn active" data-filter="all">All</button>
                    <button class="history-filter-btn" data-filter="deposit">Deposits</button>
                    <button class="history-filter-btn" data-filter="withdrawal">Withdrawals</button>
                    <button class="history-filter-btn" data-filter="plan">Plan Transactions</button>
                    <button class="history-filter-btn" data-filter="nft">NFT Transactions</button>
                    <button class="history-filter-btn" data-filter="bonus">Referral Bonuses</button>
                </div>
                
                <!-- This will now hold ALL history data -->
                <ul id="history-list-combined" class="history-list">
                    <p class="info-text" id="no-transactions-msg">No transactions recorded yet.</p>
                </ul>
            </div>
        </section>

        <!-- [NEW] Ranking Page (Updated Style) -->
        <section id="ranking-page" class="page">
            <div class="page-header">
                <h3>Live User Ranking</h3>
            </div>
            <div class="content-panel">
                <h3>Top 50 Crypto Titans</h3>
                <p class="info-text" style="margin-bottom: 25px;">Ranked by Estimated Net Worth.</p>
                <div class="ranking-header-row" style="display: flex; justify-content: space-between; padding: 10px 15px; background-color: var(--background-secondary); border-radius: 12px; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">
                    <span style="width: 15%;">Rank</span>
                    <span style="width: 40%;">User</span>
                    <span style="width: 45%; text-align: right;">Net Worth (PKR)</span>
                </div>
                <!-- Updated message for clear data state -->
                <ul id="ranking-list" class="history-list" style="max-height: 60vh; padding-right: 0;">
                    <p class="info-text" id="no-ranking-msg">No ranking data available yet. Start investing to see your rank!</p>
                </ul>
            </div>
            <div class="content-panel" id="user-rank-panel">
                <h3>Your Rank</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Your Net Worth</div>
                        <div class="value" id="my-net-worth-value">PKR 0</div>
                    </div>
                    <div class="stat-card">
                        <span class="label">Your Global Rank</span>
                        <span class="value" id="my-global-rank-value" style="color: var(--warning-color);">N/A</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Wallet Page (History Removed) -->
        <section id="wallet-page" class="page">
             <div class="page-header">
                <h3>My Wallet</h3>
            </div>
            <div class="content-panel">
                
                <div class="balance-display"><span class="amount" id="wallet-pkr-balance">PKR 0</span><span class="currency">Available PKR Balance</span></div>
                <div class="balance-on-hold" id="wallet-on-hold-balance">On Hold: PKR 0</div>
                <!-- MODIFIED BUTTONS STYLE/SIZE -->
                <div class="wallet-actions">
                    <button class="btn btn-buy" id="recharge-btn-modal" style="border-radius: 14px;"><i class="fas fa-plus-circle"></i>&nbsp; Recharge (PKR)</button>
                    <button class="btn btn-sell" id="withdraw-btn-modal" style="border-radius: 14px;"><i class="fas fa-paper-plane"></i>&nbsp; Withdraw (PKR)</button>
                </div>
            </div>
        </section>

        <!-- Profile Page (Simplified - actions are now in sidebar) -->
        <section id="profile-page" class="page">
            <div class="page-header">
                <h3>My Profile</h3>
            </div>
            <div class="content-panel">
                <div class="profile-header">
                    <div class="profile-avatar"><i class="fas fa-user-astronaut"></i></div>
                    <h2 id="profile-username-display">...</h2>
                    <p id="profile-email-display">...</p>
                </div>
                <div style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="label">User ID</div>
                        <div class="value" id="profile-uid-display" style="font-size: 1.2em; font-family: monospace;">...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Invite Page (REPLACED Network System) -->
        <section id="invite-page" class="page">
            <div class="page-header">
                <h3>Your Network</h3>
            </div>
            <div class="content-panel">
                <div class="bonus-display">
                    <div class="label">Unclaimed Network Income (PKR)</div>
                    <div class="amount" id="unclaimed-bonus-amount">PKR 0</div>
                </div>
                <button class="btn btn-claim full-width" id="collect-bonus-btn" disabled><span class="btn-text">Collect Income</span><div class="spinner-sm"></div></button>
            </div>
            
            <!-- NEW: Referral Lock/Unlock Status Panel will be inserted here by JS -->

            <div class="content-panel invite-box">
                <div class="icon"><i class="fas fa-cubes"></i></div>
                <p>Share your link. You earn commissions from your direct referrals and indirect referrals! <b>(A plan purchase is required to activate bonus earning)</b></p>
                <div class="invite-link-container">
                    <span class="network-code" id="invite-link-display">Generating...</span>
                    <button class="copy-btn-new" id="copy-invite-link-btn">
                        <i class="fas fa-copy"></i> <span>COPY LINK</span>
                    </button>
                </div>
            </div>
            
            <!-- [START] REPLACED Network Diagram with Hexagons -->
            <div class="content-panel" style="background: transparent; border: none; box-shadow: none; padding: 0;">
                <div id="hexagon-network-container" class="network-container">
                    <!-- The Hexagon Network will be dynamically generated here by JavaScript -->
                    <p class="info-text">Loading network data...</p>
                </div>
            </div>
            <!-- [END] REPLACED Network Diagram -->
        </section>
        
        <!-- Security Page (Removed back button) -->
        <section id="security-page" class="page">
            <div class="page-header">
                <h3>Security Center</h3>
            </div>
            <div class="content-panel">
                <h3>Change Password</h3>
                <form id="change-password-form">
                    <div class="input-group">
                        <input type="password" id="current-password" placeholder="Current Security Key" required autocomplete="current-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-key"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="password" id="new-password" placeholder="New Security Key" required autocomplete="new-password">
                        <i class="fa-solid fa-eye toggle-password"></i> <!-- Toggle Icon (Left) -->
                        <i class="fa-solid fa-lock"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width"><span class="btn-text">Change Password</span><div class="spinner-sm"></div></button>
                </form>
            </div>
        </section>

        <!-- Free Mining Page (Removed back button) -->
        <section id="free-mining-page" class="page">
             <div class="page-header">
                <h3>Gain Free Earning Plan</h3>
            </div>
             <div class="content-panel invite-box">
                <div class="icon" style="color: var(--success-color); text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);"><i class="fas fa-gifts"></i></div>
                <h3>Unlock a Permanent Free Earning Plan!</h3>
                <p>As a special reward for our community builders, you can earn a free lifetime plan.</p>
                <p><b>Requirement:</b> Invite 2 new users. After each of them has made their first deposit and purchased an earning plan, you become eligible.</p>
                <div class="stat-card" style="margin: 25px 0;">
                    <div class="label">Your Progress</div>
                    <div class="value" id="free-mining-progress">0 / 2</div>
                    <p class="info-text" style="margin-top: 10px;">Active Referrals</p>
                </div>
                <p>Once your progress bar shows <b>2 / 2</b>, please contact our customer service via the Telegram button to claim your reward. Our team will verify your referrals and activate your free plan.</p>
            </div>
        </section>
        
        <!-- About Us Page (Removed back button) -->
        <section id="about-us-page" class="page">
            <div class="page-header">
                <h3>About Digital Wealth Platform</h3>
            </div>
            <div class="content-panel">
                <h3>Our Vision: The Future of Digital Networks</h3>
                <p class="info-text" style="text-align: left; margin-bottom: 20px;">Our platform was founded on the principle of bridging the gap between the stability of traditional finance and the limitless potential of digital asset management. Our mission is to create an accessible, secure, and profitable ecosystem for everyone, from novices to seasoned investors.</p>
                <p class="info-text" style="text-align: left;">We believe in empowering our community through innovative solutions like our Earning Plans and network rewards. By rewarding users for their participation and loyalty, we are building a robust and self-sustaining digital economy. Join us as we redefine the future of wealth management.</p>

                <div class="fbr-certificate">
                    <h4>Federal Board of Revenue</h4>
                    <p><strong>Certificate of Registration</strong></p>
                    <p>This is to certify that</p>
                    <p style="font-weight: bold; font-size: 1.3em;">DIGITAL ASSET MANAGEMENT LTD.</p>
                    <p>is registered with the Federal Board of Revenue, under the Companies Act, 2017.</p>
                    <p><strong>Registration Number:</strong> 00198756-2024</p>
                    <p><strong>Date of Incorporation:</strong> JAN 01, 2024</p>
                    <div class="seal"><i class="fas fa-stamp"></i></div>
                    <p style="font-size: 0.8em; margin-top: 10px;">Official Seal - Government of Pakistan</p>
                </div>
            </div>
        </section>

        <!-- [NEW] NFT Page (Removed back button) -->
        <section id="nft-page" class="page">
            <div class="page-header">
                <h3>NFT Investment Collection</h3>
            </div>
            
            <!-- NEW: NFT Requirement Panel -->
            <div class="content-panel" id="nft-requirement-panel">
                <!-- Content injected by JS: locked/unlocked status, progress bar -->
                <p class="info-text">Loading NFT Requirement Status...</p>
            </div>
            <!-- END NEW: NFT Requirement Panel -->

            <div class="content-panel">
                <p class="info-text" style="margin-bottom: 25px;">Purchase an NFT to earn daily returns on your investment. Your available balance is <b id="nft-page-pkr-balance">PKR 0</b>.</p>
                <button class="btn full-width" id="view-my-nfts-btn"><span class="btn-text">View My NFTs (Achieved)</span></button>
            </div>
            <div class="nft-grid" id="nft-grid-container">
                <!-- Bronze Card -->
                <div class="nft-card" id="nft-bronze">
                    <div class="nft-visual"><i class="fas fa-shield-alt"></i></div>
                    <h4>Bronze Miner NFT</h4>
                    <p class="price-range">PKR 2,800 - PKR 8,400</p>
                    <ul class="nft-details">
                        <li><span>Daily Earning</span><span>3%</span></li>
                        <li><span>Total Return</span><span>300%</span></li>
                        <li><span>Duration</span><span>100 Days</span></li>
                    </ul>
                    <div class="input-group">
                        <input type="number" placeholder="Amount (2800-8400)" class="nft-buy-amount" min="2800" max="8400">
                        <i class="fa-solid fa-money-bill"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button class="btn btn-buy-nft" data-nft-id="bronze" data-min="2800" data-max="8400" style="border-radius: 14px;">
                        <span class="btn-text">Buy Now</span><div class="spinner-sm"></div>
                    </button>
                </div>
                <!-- Silver Card -->
                <div class="nft-card" id="nft-silver">
                    <div class="nft-visual"><i class="fas fa-star-of-david"></i></div>
                    <h4>Silver Prospector NFT</h4>
                    <p class="price-range">PKR 8,680 - PKR 14,000</p>
                    <ul class="nft-details">
                        <li><span>Daily Earning</span><span>3%</span></li>
                        <li><span>Total Return</span><span>300%</span></li>
                        <li><span>Duration</span><span>100 Days</span></li>
                    </ul>
                    <div class="input-group">
                        <input type="number" placeholder="Amount (8680-14000)" class="nft-buy-amount" min="8680" max="14000">
                        <i class="fa-solid fa-money-bill"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button class="btn btn-buy-nft" data-nft-id="silver" data-min="8680" data-max="14000" style="border-radius: 14px;">
                        <span class="btn-text">Buy Now</span><div class="spinner-sm"></div>
                    </button>
                </div>
                <!-- Gold Card -->
                <div class="nft-card" id="nft-gold">
                    <div class="nft-visual"><i class="fas fa-crown"></i></div>
                    <h4>Gold Titan NFT</h4>
                    <p class="price-range">PKR 14,280 - PKR 28,000</p>
                    <ul class="nft-details">
                        <li><span>Daily Earning</span><span>3%</span></li>
                        <li><span>Total Return</span><span>300%</span></li>
                        <li><span>Duration</span><span>100 Days</span></li>
                    </ul>
                    <div class="input-group">
                        <input type="number" placeholder="Amount (14280-28000)" class="nft-buy-amount" min="14280" max="28000">
                        <i class="fa-solid fa-money-bill"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button class="btn btn-buy-nft" data-nft-id="gold" data-min="14280" data-max="28000" style="border-radius: 14px;">
                        <span class="btn-text">Buy Now</span><div class="spinner-sm"></div>
                    </button>
                </div>
            </div>
        </section>

        <!-- [NEW] My NFTs Page (History Removed) -->
        <section id="my-nfts-page" class="page">
            <div class="page-header">
                <!-- Keep internal back button to NFT Page -->
                <button class="back-btn" data-target="nft-page"><i class="fas fa-arrow-left"></i></button>
                <h3>My NFT Portfolio</h3>
            </div>
            <div id="my-nfts-list">
                <!-- User's purchased NFTs will be populated here by JS -->
            </div>
            <div class="content-panel" id="no-nfts-msg" style="display: none;">
                <p class="info-text">You have not purchased any NFTs yet. Visit the NFT Collection to get started.</p>
            </div>
        </section>

        <!-- [NEW] Sell Products Page (Removed back button) -->
        <section id="sell-products-page" class="page">
            <div class="page-header">
                <h3>Sell Our Products</h3>
            </div>
            <div class="content-panel invite-box">
                 <div class="icon" style="color: var(--primary-accent);"><i class="fas fa-tools"></i></div>
                <h2>Coming Soon!</h2>
                <p>An exciting new feature is under development. Soon, you'll be able to sell our products and earn generous commissions. Stay tuned for updates!</p>
            </div>
        </section>

        <!-- Bottom Navigation Bar (Updated names and target pages) -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="invite-page"><i class="fas fa-link"></i><span>Network</span></button>
            <button class="nav-btn" data-page="ranking-page"><i class="fas fa-chart-bar"></i><span>Rank</span></button>
            <button class="nav-btn" data-page="wallet-page"><i class="fas fa-wallet"></i><span>Assets</span></button>
            <button class="nav-btn" data-page="profile-page"><i class="fas fa-user-circle"></i><span>Me</span></button>
        </nav>
    </div>

    <!-- Modals (Kept as is) -->
    
    <!-- MODAL FOR FORGOT PASSWORD (NEW) -->
    <div id="forgot-password-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="forgot-password-modal"></button>
            <h3>Reset Your Password</h3>
            <p class="info-text">Enter your account email address. We will send you a link to reset your password.</p>
            <form id="forgot-password-form">
                <div class="input-group">
                    <input type="email" id="reset-email" required placeholder="Registered Email Address" autocomplete="email">
                    <i class="fa-solid fa-envelope"></i> <!-- Static Icon (Right) -->
                </div>
                <button type="submit" class="btn full-width" id="submit-reset-email-btn" style="border-radius: 14px;">
                    <span class="btn-text">Send Reset Link</span><div class="spinner-sm"></div>
                </button>
            </form>
        </div>
    </div>
    <!-- END MODAL FOR FORGOT PASSWORD -->

    <!-- MODIFIED RECHARGE MODAL FOR PKR (TWO STEPS) -->
    <div id="recharge-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="recharge-modal"></button>
            <h3 id="recharge-modal-title">Recharge PKR</h3>
            
            <!-- STEP 1: Method Selection and Amount -->
            <div id="recharge-step-1">
                <p class="info-text">Select your payment method and enter the recharge amount.</p>
                <form id="recharge-step-1-form">
                    <div class="input-group">
                        <select id="recharge-network-select" required>
                            <option value="">-- Select Payment Method --</option>
                            <option value="easypaisa">Easypaisa</option>
                            <option value="jazzcash">JazzCash</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <input type="number" id="recharge-amount-step1" placeholder="Amount (PKR)" required min="100" step="1">
                        <i class="fa-solid fa-rupiah-sign"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button type="submit" class="btn full-width" id="recharge-step-1-next-btn" style="border-radius: 14px;">
                        <span class="btn-text">Next: View Details</span><div class="spinner-sm"></div>
                    </button>
                </form>
            </div>

            <!-- STEP 2: Details and Proof Submission -->
            <div id="recharge-step-2" style="display: none;">
                <p class="info-text" id="recharge-details-info">Send money to the account below, or scan the QR code:</p>
                
                <!-- Dynamic Details Container (Easypaisa/JazzCash) -->
                <div id="recharge-details-container" style="text-align: center; margin-bottom: 25px;">
                    <!-- Details will be injected here by JS -->
                </div>
                
                <p class="info-text" style="margin-top: 25px;">After sending, enter the transaction proof below and submit.</p>
                
                <form id="recharge-form">
                    <!-- Hidden fields to carry over the selection from Step 1 -->
                    <input type="hidden" id="recharge-network-hidden" name="network">
                    <input type="hidden" id="recharge-amount-hidden" name="amount">
                    
                    <div class="input-group">
                        <input type="text" id="sender-account-number" placeholder="Your Sender Account Number (11 digits)" required pattern="\d{11}" maxlength="11">
                        <i class="fa-solid fa-phone"></i> <!-- Static Icon (Right) -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="transaction-id" placeholder="Transaction ID (TxID/TID - MUST BE CORRECT)" required>
                        <i class="fa-solid fa-receipt"></i> <!-- Static Icon (Right) -->
                    </div>
                    <button id="submit-recharge-btn" type="submit" class="btn full-width" style="border-radius: 14px;">
                        <span class="btn-text">Submit for Review</span><div class="spinner-sm"></div>
                    </button>
                    <p class="auth-switch" style="margin-top: 15px; text-align: center; margin-bottom: 0;">
                        <a href="#" id="recharge-step-2-back-link"> Change Method/Amount</a>
                    </p>
                </form>
            </div>
        </div>
    </div>
    <!-- END MODIFIED RECHARGE MODAL -->
    
    <!-- MODIFIED WITHDRAWAL MODAL FOR PKR -->
    <div id="withdrawal-modal" class="modal-overlay">
        <div class="modal-content content-panel">
            <button class="modal-close-btn" data-modal-id="withdrawal-modal"></button>
            <h3>Withdraw PKR</h3>
            <form id="withdrawal-form">
                <div class="input-group">
                    <input type="number" id="withdraw-amount" placeholder="Amount (PKR)" required min="100" step="1">
                    <i class="fa-solid fa-rupiah-sign"></i> <!-- Static Icon (Right) -->
                </div>
                <div class="input-group">
                    <select id="withdraw-network" required>
                        <option value="">-- Select Method --</option>
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="text" id="withdraw-account-number" placeholder="11-Digit Account Number" required pattern="\d{11}" maxlength="11">
                    <i class="fa-solid fa-address-card"></i> <!-- Static Icon (Right) -->
                </div>
                <div class="input-group">
                    <input type="text" id="withdraw-account-holder-name" placeholder="Account Holder Name" required>
                    <i class="fa-solid fa-user"></i> <!-- Static Icon (Right) -->
                </div>
                <button id="submit-withdrawal-btn" type="submit" class="btn full-width" style="border-radius: 14px;">
                    <span class="btn-text">Request Withdrawal</span><div class="spinner-sm"></div>
                </button>
            </form>
            <p class="info-text">A 5% service fee applies. Funds will be processed within 24 hours.</p>
        </div>
    </div>
    <!-- END MODIFIED WITHDRAWAL MODAL -->
    
    <!-- Firebase & Particle.js -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- [1] CONFIG & INITIALIZATION ---
            config: {
                firebase: {
                    // NOTE: The Firebase configuration keys below are updated as requested.
                    apiKey: "AIzaSyBrLjKm-OXg_H0YkdayyMXVBa9vzpvBjks", // UPDATED
                    authDomain: "block-chain-golden-star.firebaseapp.com", // Updated based on DB URL
                    databaseURL: "https://block-chain-golden-star-default-rtdb.asia-southeast1.firebasedatabase.app/", // UPDATED
                    projectId: "block-chain-golden-star", // Updated based on DB URL
                    storageBucket: "block-chain-golden-star.appspot.com", // Updated based on DB URL
                    messagingSenderId: "123456789012", // Generic placeholder
                    appId: "1:123456789012:web:abcdefg123456789" // Generic placeholder
                },
                WITHDRAWAL_FEE_PERCENT: 0.05,
                PRELOADER_TIMEOUT: 8000,
                
                // --- MODIFIED PLAN CONFIG ---
                BASIC_PLAN_COST: 670,
                PRO_PLAN_COST: 12500,
                PRO_PLAN_DAILY_RATE: 0.01, // 1% daily
                MINIMUM_PROFIT_CLAIM: 1, // PKR 1 minimum claim
                // --- END MODIFIED PLAN CONFIG ---
                
                // Referral config - CHANGED: Direct bonus from 50% to 30%
                REFERRAL_LEVELS: 9,
                REFERRAL_DIRECT_BONUS_PERCENT: 0.30, // CHANGED from 0.50 to 0.30
                REFERRAL_INDIRECT_BONUS_PERCENT: 0.03,
                
                // FREE PLAN GATE
                FREE_PLAN_REQUIRED_REFERRALS: 2, 
                
                RANKING_LIMIT: 50,
                
                // NFT Config
                NFT_DAILY_RATE_PERCENT: 0.03, 
                NFT_TOTAL_RETURN_PERCENT: 3.00, 
                NFT_DURATION_DAYS: 100,
                NFT_REQUIRED_ACTIVE_REFERRALS: 10,
                
                // PKR Deposit Info (UPDATED with new details and JazzCash)
                PAYMENT_METHODS: {
                    easypaisa: {
                        name: 'Easypaisa',
                        accountNumber: '03184336430', // UPDATED
                        accountHolder: 'Sonia Eman', // UPDATED
                        qrUrl: 'https://iili.io/KLcZF5B.jpg' // UPDATED
                    },
                    jazzcash: {
                        name: 'JazzCash',
                        accountNumber: '03199242314', // NEW
                        accountHolder: 'Kinza Tariq', // NEW
                        qrUrl: 'https://iili.io/KLcpcla.jpg' // NEW
                    }
                },
            },

            // --- [2] STATE MANAGEMENT ---
            state: {
                currentUser: null,
                userData: null,
                allUsersData: [], 
                userRef: null,
                txRef: null,
                preloaderTimeoutId: null,
                planProfitInterval: null, 
                nftIntervals: {},
                ui: {},
                historyFilter: 'all', // NEW: Track current history filter
                recharge: {
                    network: null,
                    amount: 0
                },
                carouselInterval: null // NEW: Carousel interval state
            },

            async init() {
                this.cacheDOMElements();
                this.initFirebase();
                this.initDraggableFAB();
                this.listenToAllUserData();
                this.initParticles();
                this.bindEventListeners();
                this.initLandingPageAnimations();
                this.handleAuth();
                this.state.preloaderTimeoutId = setTimeout(() => this.hidePreloader(), this.config.PRELOADER_TIMEOUT);
                this.checkForRefCode();
                this.updatePlansUI(); // Initial plans UI render
                this.initHomeCarousel(); // NEW: Initialize carousel
            },

            initFirebase() {
                try {
                    const firebaseConfig = this.config.firebase;
                    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                    this.auth = firebase.auth();
                    this.db = firebase.database();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    this.showToast('Application failed to load.', 'danger');
                }
            },
            
            listenToAllUserData() {
                this.db.ref('users').on('value', (snapshot) => {
                    const allUsers = snapshot.val();
                    if (allUsers) {
                        const rankedUsers = Object.entries(allUsers).map(([uid, data]) => ({
                            ...data,
                            uid: uid,
                            netWorth: this.calculateUserNetWorth(data)
                        }));

                        rankedUsers.sort((a, b) => b.netWorth - a.netWorth);
                        this.state.allUsersData = rankedUsers;
                        if (this.state.currentUser) this.updateRankingUI(); 
                    }
                }, (error) => {
                    console.error("Firebase all user data error for ranking:", error);
                });
            },

            initParticles() {
                if (typeof particlesJS !== 'undefined') {
                    particlesJS('particles-js', {"particles":{"number":{"value":50,"density":{"enable":true,"value_area":800}},"color":{"value":"#FFC300"},"shape":{"type":"circle"},"opacity":{"value":0.6,"random":true,"anim":{"enable":true,"speed":1,"opacity_min":0.1}},"size":{"value":2,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#B8860B","opacity":0.15,"width":1},"move":{"enable":true,"speed":1,"direction":"none","random":true,"straight":false,"out_mode":"out"}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"}},"modes":{"grab":{"distance":140,"line_linked":{"opacity":0.2}},"push":{"particles_nb":4}}},"retina_detect":true});
                }
            },
            
            // NEW: Carousel Initialization
            initHomeCarousel() {
                const carousel = document.getElementById('home-carousel');
                if (!carousel) return;
                const slides = carousel.querySelectorAll('.carousel-slide');
                let currentIndex = 0;
                const totalSlides = slides.length;

                const moveSlide = () => {
                    currentIndex = (currentIndex + 1) % totalSlides;
                    const offset = -currentIndex * 100;
                    carousel.style.transform = `translateX(${offset}%)`;
                };

                // Clear any existing interval before setting a new one
                if (this.state.carouselInterval) {
                    clearInterval(this.state.carouselInterval);
                }
                
                // Start auto-sliding every 5 seconds
                this.state.carouselInterval = setInterval(moveSlide, 5000);
            },

            // --- [3] UI / DOM MANIPULATION ---
            cacheDOMElements() {
                this.state.ui = {
                    body: document.body,
                    landingPageContainer: document.getElementById('landing-page-container'),
                    preloader: document.getElementById('preloader'), authContainer: document.getElementById('auth-container'), appContainer: document.getElementById('app-container'), toastContainer: document.getElementById('toast-container'), telegramFab: document.getElementById('telegram-fab'),
                    loginPage: document.getElementById('login-page-container'), registerPage: document.getElementById('register-page-container'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), registerRefCodeInput: document.getElementById('register-ref-code'),
                    
                    // New App Header & Sidebar
                    appHeader: document.getElementById('app-header'),
                    menuToggleBtn: document.getElementById('menu-toggle-btn'),
                    appSidebar: document.getElementById('app-sidebar'),
                    sidebarOverlay: document.getElementById('sidebar-overlay'),
                    sidebarUsernameDisplay: document.getElementById('sidebar-username-display'),
                    sidebarEmailDisplay: document.getElementById('sidebar-email-display'),
                    sidebarUidDisplay: document.getElementById('sidebar-uid-display'),
                    sidebarLogoutBtn: document.getElementById('sidebar-logout-btn'),

                    welcomeUser: document.getElementById('welcome-user'), 
                    homePkrBalance: document.getElementById('home-pkr-balance'), 
                    homeActivePlan: document.getElementById('home-active-plan'),
                    
                    // NEW: Enhanced Active Plan Display
                    activePlanDisplay: document.getElementById('active-plan-display'),
                    activePlanName: document.getElementById('active-plan-name'),
                    activePlanInvestment: document.getElementById('active-plan-investment'),
                    activePlanDailyProfit: document.getElementById('active-plan-daily-profit'),
                    activePlanAccumulated: document.getElementById('active-plan-accumulated'),
                    activePlanNextClaim: document.getElementById('active-plan-next-claim'),
                    activePlanProgressText: document.getElementById('active-plan-progress-text'),
                    activePlanProgressBar: document.getElementById('active-plan-progress-bar'),
                    
                    // New Plan UI Elements
                    plansPagePkrBalance: document.getElementById('plans-page-pkr-balance'), 
                    marketingPlansContainer: document.getElementById('marketing-plans-container'),
                    marketingPlansPanel: document.getElementById('marketing-plans-panel'),
                    claimPlanProfitBtn: document.getElementById('claim-plan-profit-btn'),
                    
                    walletPkrBalance: document.getElementById('wallet-pkr-balance'), 
                    walletOnHoldBalance: document.getElementById('wallet-on-hold-balance'), 
                    
                    // MODIFIED Recharge Modal elements
                    rechargeStep1: document.getElementById('recharge-step-1'),
                    rechargeStep1Form: document.getElementById('recharge-step-1-form'),
                    rechargeNetworkSelect: document.getElementById('recharge-network-select'),
                    rechargeAmountStep1: document.getElementById('recharge-amount-step1'),
                    rechargeStep2: document.getElementById('recharge-step-2'),
                    rechargeDetailsContainer: document.getElementById('recharge-details-container'),
                    rechargeNetworkHidden: document.getElementById('recharge-network-hidden'),
                    rechargeAmountHidden: document.getElementById('recharge-amount-hidden'),
                    rechargeStep2BackLink: document.getElementById('recharge-step-2-back-link'),
                    rechargeModalTitle: document.getElementById('recharge-modal-title'),
                    
                    rechargeForm: document.getElementById('recharge-form'), 
                    withdrawalForm: document.getElementById('withdrawal-form'),
                    
                    // Ranking UI Elements
                    rankingList: document.getElementById('ranking-list'),
                    myNetWorthValue: document.getElementById('my-net-worth-value'),
                    myGlobalRankValue: document.getElementById('my-global-rank-value'),
                    
                    profileUsernameDisplay: document.getElementById('profile-username-display'), profileEmailDisplay: document.getElementById('profile-email-display'), profileUidDisplay: document.getElementById('profile-uid-display'),
                    changePasswordForm: document.getElementById('change-password-form'),
                    inviteLinkDisplay: document.getElementById('invite-link-display'),
                    
                    unclaimedBonusAmount: document.getElementById('unclaimed-bonus-amount'), collectBonusBtn: document.getElementById('collect-bonus-btn'), 
                    
                    // --- [REPLACED] Network UI Elements ---
                    hexagonNetworkContainer: document.getElementById('hexagon-network-container'),
                    // --- End Network UI Elements ---

                    freeMiningProgress: document.getElementById('free-mining-progress'),
                    
                    nftPagePkrBalance: document.getElementById('nft-page-pkr-balance'),
                    nftGridContainer: document.getElementById('nft-grid-container'),
                    myNftsListPage: document.getElementById('my-nfts-page'),
                    myNftsList: document.getElementById('my-nfts-list'),
                    noNftsMsg: document.getElementById('no-nfts-msg'),
                    viewMyNftsBtn: document.getElementById('view-my-nfts-btn'),
                    
                    // NEW: NFT Requirement Panel
                    nftRequirementPanel: document.getElementById('nft-requirement-panel'),

                    // History List Elements
                    historyLists: {
                        combined: { list: document.getElementById('history-list-combined'), msg: document.getElementById('no-transactions-msg') },
                    }
                };
            },
            
            showPage(pageId) { 
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
                document.getElementById(pageId)?.classList.add('active'); 
                
                // Close sidebar when navigating to a page
                this.closeSidebar(); 
                
                // Update bottom nav active state
                document.querySelectorAll('.nav-btn').forEach(b => {
                    const isMainTab = ['home-page', 'invite-page', 'ranking-page', 'wallet-page', 'profile-page'].includes(pageId);
                    b.classList.toggle('active', isMainTab && b.dataset.page === pageId);
                });
                
                window.scrollTo(0, 0); 
            },
            showModal(modalId) { document.getElementById(modalId)?.classList.add('active'); },
            hideModal(modalId) { document.getElementById(modalId)?.classList.remove('active'); },
            showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; this.state.ui.toastContainer.appendChild(toast); setTimeout(() => toast.remove(), 4000); },
            hidePreloader() { if (this.state.preloaderTimeoutId) clearTimeout(this.state.preloaderTimeoutId); this.state.ui.preloader.classList.add('hidden'); },
            setButtonLoading(btn, isLoading) { if (btn) { btn.classList.toggle('loading', isLoading); btn.disabled = isLoading; } },
            
            openSidebar() {
                this.state.ui.appSidebar.classList.add('active');
                this.state.ui.sidebarOverlay.style.display = 'block';
            },

            closeSidebar() {
                this.state.ui.appSidebar.classList.remove('active');
                this.state.ui.sidebarOverlay.style.display = 'none';
            },

            updateUI() {
                if (!this.state.userData) return;
                const { username, email, uid, referralCode, pkr_balance = 0, balance_on_hold = 0, active_plan } = this.state.userData;

                const formatCurrencyPKR = (num) => `PKR ${Math.round(Number(num || 0)).toLocaleString()}`;
                
                // Common UI elements
                this.state.ui.welcomeUser.textContent = `Welcome, ${username || email.split('@')[0]}`;
                
                // Balances
                this.state.ui.homePkrBalance.textContent = formatCurrencyPKR(pkr_balance); 
                this.state.ui.homeActivePlan.textContent = active_plan || 'None';
                
                this.state.ui.walletPkrBalance.textContent = formatCurrencyPKR(pkr_balance); 
                this.state.ui.walletOnHoldBalance.textContent = `On Hold: ${formatCurrencyPKR(balance_on_hold)}`;
                
                this.state.ui.nftPagePkrBalance.textContent = formatCurrencyPKR(pkr_balance);
                
                this.state.ui.plansPagePkrBalance.textContent = formatCurrencyPKR(pkr_balance); 
                
                // Profile Page & Sidebar
                this.state.ui.profileUsernameDisplay.textContent = username || 'Not Set';
                this.state.ui.profileEmailDisplay.textContent = email;
                this.state.ui.profileUidDisplay.textContent = uid;

                this.state.ui.sidebarUsernameDisplay.textContent = username || 'Not Set';
                this.state.ui.sidebarEmailDisplay.textContent = email;
                this.state.ui.sidebarUidDisplay.textContent = uid;
                
                // Invite Page
                this.state.ui.inviteLinkDisplay.innerText = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;
                
                // Update component-specific UIs
                this.updatePlanUI(); 
                this.updateNetworkUI(); // MODIFIED
                this.updateFreeMiningUI();
                this.updateNFTRequirementUI(); 
                this.updateMyNftsUI();
                this.updateRankingUI();
            },

            calculateUserHoldings(userData) {
                const planInvestment = userData.plans?.totalInvestmentPKR || 0;
                const planProfit = userData.plans?.totalProfitGeneratedPKR || 0;
                let nftValue = 0;
                if (userData.nfts) {
                    Object.values(userData.nfts).forEach(nft => {
                        nftValue += (nft.investment || 0) + (nft.totalProfitClaimed || 0); 
                    });
                }
                // Holdings = Liquid PKR + Plan Investment + Plan Profit + NFT Value
                return (userData.pkr_balance || 0) + planInvestment + planProfit + nftValue;
            },

            // MODIFIED: Enhanced history system with filtering
            updateAllHistories(transactions) {
                const txArray = transactions ? Object.values(transactions).sort((a, b) => b.timestamp - a.timestamp) : [];

                // Apply filter if set
                let filteredTransactions = txArray;
                if (this.state.historyFilter !== 'all') {
                    filteredTransactions = txArray.filter(tx => {
                        if (this.state.historyFilter === 'deposit') return tx.type === 'deposit';
                        if (this.state.historyFilter === 'withdrawal') return tx.type === 'withdrawal';
                        if (this.state.historyFilter === 'plan') return tx.type.includes('plan');
                        if (this.state.historyFilter === 'nft') return tx.type.includes('nft');
                        if (this.state.historyFilter === 'bonus') return tx.type.includes('bonus');
                        return true;
                    });
                }

                // All transactions go to the combined list
                this.populateHistoryList(this.state.ui.historyLists.combined, filteredTransactions);
            },

            populateHistoryList(listConfig, transactions) {
                if (!listConfig || !listConfig.list || !listConfig.msg) return;
                const { list, msg } = listConfig;

                list.innerHTML = '';
                if (transactions.length === 0) {
                    list.appendChild(msg);
                    return;
                }
                
                // Hide the placeholder message if it was mistakenly appended
                if (msg.parentElement === list) {
                    msg.remove();
                }

                transactions.forEach(tx => {
                    const item = document.createElement('li');
                    const status = tx.details?.status?.toLowerCase(); // 'pending', 'approved', 'rejected'
                    
                    let statusClass = '';
                    if (status === 'pending') statusClass = 'pending';
                    else if (status === 'approved') statusClass = 'approved';
                    else if (status === 'rejected') statusClass = 'rejected';
                    
                    item.className = `transaction-item ${tx.type.toLowerCase().replace('mining', 'plan')} ${statusClass}`;
                    
                    // Updated icons for transaction types
                    const icons = { deposit: 'fa-arrow-down', withdrawal: 'fa-paper-plane', bonus: 'fa-gift', plan_profit: 'fa-arrow-up-right-dots', plan_invest: 'fa-sack-dollar', invite_bonus: 'fa-users', nft_purchase: 'fa-gem', nft_profit: 'fa-hand-holding-usd' };
                    
                    let amountDisplay;
                    let typeText = tx.type.replace(/_/g, ' ').replace('plan', 'plan').replace('invest', 'purchase');
                    
                    const sign = ['withdrawal', 'nft_purchase', 'plan_invest'].includes(tx.type) ? '-' : '+';
                    amountDisplay = `${sign}PKR ${Math.round(tx.amount).toLocaleString()}`;

                    // Status display text
                    let statusDisplay = '';
                    if (status === 'pending') statusDisplay = `<span style="color: var(--warning-color); font-weight: normal;">(Pending)</span>`;
                    else if (status === 'rejected') statusDisplay = `<span style="color: var(--danger-color); font-weight: normal;">(Rejected)</span>`;
                    else if (status === 'approved') statusDisplay = `<span style="color: var(--success-color); font-weight: normal;">(Approved)</span>`;

                    const typeDisplay = (tx.details?.reason || typeText) + statusDisplay;

                    item.innerHTML = `<div class="icon"><i class="fas ${icons[tx.type.toLowerCase()] || 'fa-exchange-alt'}"></i></div><div class="details"><div class="type">${typeDisplay}</div><div class="date">${new Date(tx.timestamp).toLocaleString()}</div></div><div class="amount">${amountDisplay}</div>`;
                    list.appendChild(item);
                });
            },
            
            // --- [4] EVENT LISTENERS & HANDLERS ---
            bindEventListeners() {
                // Landing Page
                document.querySelectorAll('.enter-app-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.state.ui.landingPageContainer.style.display = 'none';
                        this.state.ui.body.classList.remove('landing-visible');
                        this.state.ui.authContainer.classList.add('active');
                    });
                });
                window.addEventListener('scroll', () => {
                    const header = document.getElementById('landing-header');
                    if (header) { 
                        if (window.scrollY > 50) {
                            header.classList.add('scrolled');
                        } else {
                            header.classList.remove('scrolled');
                        }
                    }
                });

                // Auth
                document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); this.state.ui.loginPage.style.display = 'none'; this.state.ui.registerPage.style.display = 'block'; });
                document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); this.state.ui.registerPage.style.display = 'none'; this.state.ui.loginPage.style.display = 'block'; });
                
                // NEW: Forgot Password Link
                document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    this.showModal('forgot-password-modal'); 
                });
                document.getElementById('forgot-password-form').addEventListener('submit', (e) => this.handleForgotPassword(e));

                this.state.ui.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.state.ui.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                
                // --- MODIFIED Password Toggle: Only react to icon click ---
                document.querySelectorAll('.toggle-password').forEach(toggle => { 
                    // Ensures the click only works on the icon itself, not the input
                    toggle.addEventListener('click', (e) => { 
                        const icon = e.target; 
                        // Find the input element sibling within the same input-group
                        const input = icon.closest('.input-group')?.querySelector('input[type="password"], input[type="text"]'); 
                        
                        if(input) { 
                            if (input.type === 'password') {
                                input.type = 'text';
                                icon.classList.remove('fa-eye');
                                icon.classList.add('fa-eye-slash');
                            } else {
                                input.type = 'password';
                                icon.classList.remove('fa-eye-slash');
                                icon.classList.add('fa-eye');
                            }
                        } 
                    }); 
                });
                // --- END MODIFIED Password Toggle ---

                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => this.showPage(btn.dataset.page)));
                
                // Sidebar Navigation
                this.state.ui.menuToggleBtn.addEventListener('click', () => this.openSidebar());
                this.state.ui.sidebarOverlay.addEventListener('click', () => this.closeSidebar());
                document.querySelectorAll('#app-sidebar .action-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.showPage(card.dataset.pageTarget);
                    });
                });
                this.state.ui.sidebarLogoutBtn?.addEventListener('click', (e) => this.handleLogout(e));
                
                // Sub-page back buttons
                document.querySelectorAll('.page-header .back-btn').forEach(btn => btn.addEventListener('click', () => this.showPage(btn.dataset.target)));

                // Modals
                document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => this.hideModal(btn.dataset.modalId)));
                document.getElementById('recharge-btn-modal').addEventListener('click', () => this.showRechargeStep1()); // MODIFIED: Call Step 1 function
                document.getElementById('withdraw-btn-modal').addEventListener('click', () => this.showModal('withdrawal-modal'));
                
                // Core Features - MODIFIED Recharge flow
                this.state.ui.rechargeStep1Form.addEventListener('submit', (e) => this.handleRechargeStep1(e)); // NEW listener
                this.state.ui.rechargeStep2BackLink.addEventListener('click', (e) => { e.preventDefault(); this.showRechargeStep1(); }); // NEW back link listener
                this.state.ui.rechargeForm.addEventListener('submit', (e) => this.handleRecharge(e)); // Step 2 submission
                this.state.ui.withdrawalForm.addEventListener('submit', (e) => this.handleWithdraw(e));
                
                // Plan Purchase - MODIFIED: Direct purchase
                this.state.ui.marketingPlansContainer.addEventListener('click', e => {
                    const btn = e.target.closest('.btn-purchase-plan');
                    if (btn) this.handleDirectPlanPurchase(btn.dataset.planId);
                });
                this.state.ui.claimPlanProfitBtn.addEventListener('click', e => this.handleClaimPlanProfit(e));

                // Buttons and Inputs
                this.state.ui.changePasswordForm.addEventListener('submit', e => this.handleChangePassword(e));
                document.getElementById('copy-invite-link-btn').addEventListener('click', (e) => this.copyToClipboard(this.state.ui.inviteLinkDisplay.innerText, e.currentTarget, 'Link Copied!'));
                document.querySelectorAll('.address-box .copy-btn').forEach(btn => { 
                    btn.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        const targetId = btn.dataset.copyTargetId; 
                        const textToCopy = document.getElementById(targetId)?.innerText; 
                        // The logic for copying the account number/details
                        const addressBox = btn.closest('.address-box');
                        const accountHolder = addressBox.dataset.accountHolder;

                        if (textToCopy) this.copyToClipboard(textToCopy, addressBox, `${accountHolder}'s Account Number`); 
                    }); 
                });
                
                // Network and Bonus
                this.state.ui.collectBonusBtn.addEventListener('click', e => this.handleCollectInviteBonus(e));

                // NEW: History Filter Buttons
                document.querySelectorAll('.history-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.history-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.state.historyFilter = btn.dataset.filter;
                        // Re-apply the filter to current transactions
                        if (this.state.txRef) {
                            this.state.txRef.limitToLast(100).once('value', snapshot => this.updateAllHistories(snapshot.val()));
                        }
                    });
                });

                // NFT Event Listeners
                this.state.ui.viewMyNftsBtn.addEventListener('click', () => this.showPage('my-nfts-page'));
                this.state.ui.nftGridContainer.addEventListener('click', e => {
                    if (e.target.matches('.btn-buy-nft, .btn-buy-nft *')) {
                        const btn = e.target.closest('.btn-buy-nft');
                        this.handleBuyNft(btn);
                    }
                });
                this.state.ui.myNftsList.addEventListener('click', e => {
                    if (e.target.matches('.btn-claim-nft, .btn-claim-nft *')) {
                        const btn = e.target.closest('.btn-claim-nft');
                        this.handleClaimNftProfit(btn.dataset.nftKey, btn);
                    }
                });
            },
            
            initLandingPageAnimations() {
                const sections = document.querySelectorAll('.landing-section');
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, { threshold: 0.1 });
                sections.forEach(section => observer.observe(section));
            },

            checkForRefCode() { const refCode = new URLSearchParams(window.location.search).get('ref'); if (refCode) { this.state.ui.registerRefCodeInput.value = refCode; } },
            
            // --- [5] CORE LOGIC ---
            handleAuth() { 
                this.auth.onAuthStateChanged(user => { 
                    this.hidePreloader(); 
                    if (user) { 
                        this.state.currentUser = user; 
                        this.listenToUserData(); 
                        this.state.ui.landingPageContainer.style.display = 'none';
                        this.state.ui.body.classList.remove('landing-visible');
                        this.state.ui.authContainer.classList.remove('active'); 
                        this.state.ui.appContainer.classList.add('active'); 
                        this.state.ui.appHeader.style.display = 'flex'; 
                        this.showPage('home-page'); 
                    } else { 
                        this.state.currentUser = null; 
                        this.state.userData = null; 
                        this.stopAllListeners(); 
                        this.state.ui.appHeader.style.display = 'none'; 
                        this.state.ui.landingPageContainer.style.display = 'block';
                        this.state.ui.body.classList.add('landing-visible');
                        this.state.ui.authContainer.classList.remove('active'); 
                        this.state.ui.appContainer.classList.remove('active'); 
                    } 
                }); 
            },
            
            async handleRegister(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                this.setButtonLoading(btn, true);
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const repeatPassword = document.getElementById('register-repeat-password').value;
                const refCode = this.state.ui.registerRefCodeInput.value.trim();

                if (password !== repeatPassword) { this.showToast('Passwords do not match.', 'danger'); this.setButtonLoading(btn, false); return; }
                if (password.length < 6) { this.showToast('Password should be at least 6 characters.', 'danger'); this.setButtonLoading(btn, false); return; }

                try {
                    let referrerData = null;
                    let ancestry = {};
                    if(refCode) {
                        const referrerSnap = await this.db.ref('users').orderByChild('referralCode').equalTo(refCode).once('value');
                        if (referrerSnap.exists()) {
                            const referrerUid = Object.keys(referrerSnap.val())[0];
                            referrerData = referrerSnap.val()[referrerUid];
                            ancestry['level_1'] = referrerUid;
                            // Level 1 is Direct. Indirect starts at Level 2.
                            if(referrerData.ancestry){
                                // Iterate up to the new REFERRAL_LEVELS (9 indirect levels) + 1 direct level = 10 total levels (level 10 in DB is the 9th indirect level)
                                for(let i = 1; i < this.config.REFERRAL_LEVELS + 1; i++){ 
                                    if(referrerData.ancestry[`level_${i}`]){
                                        ancestry[`level_${i + 1}`] = referrerData.ancestry[`level_${i}`];
                                    } else { break; }
                                }
                            }
                        } else { this.showToast('Invalid invitation code.', 'warning'); }
                    }

                    const userCredential = await this.auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const referralCode = 'CDNC' + Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    await this.db.ref('users/' + user.uid).set({
                        username, email, uid: user.uid, referralCode, referredBy: refCode || null,
                        pkr_balance: 0, 
                        balance_on_hold: 0,
                        unclaimed_invite_bonus: 0, active_referrals_count: 0,
                        plans: { 
                            totalInvestmentPKR: 0, 
                            lastProfitClaimTimestamp: 0, 
                            firstInvestmentProcessed: false, // <-- GATES INVITATION BONUS EARNING
                            totalProfitGeneratedPKR: 0,
                            active_plan: null
                        }, 
                        nfts: {},
                        ancestry: ancestry,
                        referrals_by_level: {},
                        referrals_data: {},
                        miningGateActive: false, 
                        miningGateProgress: { activatedReferralsCount: 0, activatedReferralUIDs: {} }
                    });

                    if(Object.keys(ancestry).length > 0){
                        const updates = {};
                        for (const [level, ancestorUid] of Object.entries(ancestry)) {
                            const levelNum = parseInt(level.split('_')[1]);
                            updates[`${ancestorUid}/referrals_by_level/level_${levelNum}`] = firebase.database.ServerValue.increment(1);
                            updates[`${ancestorUid}/referrals_data/level_${levelNum}/${user.uid}`] = { username, email, joinedAt: firebase.database.ServerValue.TIMESTAMP, uid: user.uid };
                        }
                        await this.db.ref('users').update(updates);
                    }
                    
                    await user.updateProfile({ displayName: username });
                    this.showToast('Registration successful! Please log in.', 'success');
                    this.state.ui.registerForm.reset();
                    this.state.ui.registerPage.style.display = 'none';
                    this.state.ui.loginPage.style.display = 'block';
                } catch (error) { this.showToast(error.message, 'danger');
                } finally { this.setButtonLoading(btn, false); }
            },

            async handleLogin(e) { e.preventDefault(); const btn = e.target.querySelector('button'); this.setButtonLoading(btn, true); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await this.auth.signInWithEmailAndPassword(email, password); } catch (error) { this.showToast(error.message, 'danger'); } finally { this.setButtonLoading(btn, false); } },
            
            // NEW: Forgot Password Handler
            async handleForgotPassword(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                this.setButtonLoading(btn, true);
                const email = document.getElementById('reset-email').value.trim();

                try {
                    await this.auth.sendPasswordResetEmail(email);
                    this.showToast(`Password reset link sent to ${email}. Check your inbox!`, 'success');
                    this.hideModal('forgot-password-modal');
                    document.getElementById('forgot-password-form').reset();
                } catch (error) {
                    this.showToast(error.message, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            async handleLogout(e) { try { await this.auth.signOut(); } catch (error) { this.showToast(error.message, 'danger'); } },
            
            // NEW: Step 1 handler (Selection)
            handleRechargeStep1(e) {
                e.preventDefault();
                const network = this.state.ui.rechargeNetworkSelect.value;
                const amount = parseFloat(this.state.ui.rechargeAmountStep1.value);

                if (!network || isNaN(amount) || amount <= 0) {
                    return this.showToast('Please select a method and enter a valid amount.', 'danger');
                }
                
                this.state.recharge.network = network;
                this.state.recharge.amount = amount;

                this.showRechargeStep2(network, amount);
            },
            
            showRechargeStep1() {
                this.state.ui.rechargeModalTitle.textContent = 'Recharge PKR';
                this.state.ui.rechargeStep1.style.display = 'block';
                this.state.ui.rechargeStep2.style.display = 'none';
                this.showModal('recharge-modal');
                // Optional: reset amount/network fields here if needed
            },

            showRechargeStep2(network, amount) {
                const method = this.config.PAYMENT_METHODS[network];
                if (!method) {
                    this.showToast('Invalid payment method selected.', 'danger');
                    this.showRechargeStep1();
                    return;
                }

                this.state.ui.rechargeModalTitle.textContent = `Recharge PKR (${method.name})`;
                this.state.ui.rechargeStep1.style.display = 'none';
                this.state.ui.rechargeStep2.style.display = 'block';

                this.state.ui.rechargeNetworkHidden.value = network;
                this.state.ui.rechargeAmountHidden.value = amount;

                this.state.ui.rechargeDetailsContainer.innerHTML = `
                    <p class="info-text">Target Amount to Send: <b style="color: var(--primary-accent);">PKR ${amount.toLocaleString()}</b></p>
                    <div class="address-box" style="margin-top: 15px;" data-account-holder="${method.accountHolder}">
                        <span class="address" id="recharge-account-number" style="font-size: 1.1em; font-weight: 600;">${method.accountNumber}</span>
                        <button class="copy-btn" tabindex="-1" data-copy-target-id="recharge-account-number"><i class="far fa-copy"></i></button>
                    </div>
                    <p class="info-text" style="margin-bottom: 15px;">**Account Holder: <b style="color: var(--text-primary);">${method.accountHolder}</b>**</p>

                    <div style="text-align: center; margin-bottom: 25px;">
                        <img src="${method.qrUrl}" 
                             alt="${method.name} QR Code for ${method.accountHolder}" 
                             style="width: 200px; height: auto; border-radius: 10px; border: 3px solid var(--primary-accent); max-width: 80%;">
                        <p class="info-text" style="font-size: 0.8em; margin-top: 5px;">(QR code for ${method.accountHolder}'s ${method.name} account)</p>
                    </div>
                `;
            },
            
            // MODIFIED handleRecharge for PKR - Sets status to 'pending'
            async handleRecharge(e) { 
                e.preventDefault(); 
                const btn = e.currentTarget.querySelector('button'); 
                
                // Get data from hidden fields (set in Step 2)
                const pkrAmount = parseFloat(this.state.ui.rechargeAmountHidden.value); 
                const network = this.state.ui.rechargeNetworkHidden.value;
                
                const senderAccount = document.getElementById('sender-account-number').value.trim();
                const txId = document.getElementById('transaction-id').value.trim(); 
                
                // Basic validation (more checks were done in Step 1)
                if (!txId || !senderAccount || isNaN(pkrAmount) || pkrAmount <= 0) {
                    return this.showToast('Please provide valid details and Transaction ID.', 'danger'); 
                }
                if (!/^\d{11}$/.test(senderAccount)) {
                    return this.showToast('Sender Account Number must be 11 digits.', 'danger'); 
                }
                
                this.setButtonLoading(btn, true); 

                try { 
                    const targetAccount = this.config.PAYMENT_METHODS[network].accountNumber;

                    await this.db.ref('recharge_requests').push({ 
                        userId: this.state.currentUser.uid, 
                        userEmail: this.state.currentUser.email, 
                        pkrAmount: pkrAmount,
                        network, 
                        txId, 
                        senderAccount,
                        targetAccount, // For Admin reference
                        status: 'pending', 
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    }); 

                    // Log transaction with pending status for history view
                    await this.logTransaction('deposit', pkrAmount, { network, txId, senderAccount, status: 'pending' }); 
                    
                    this.showToast(`Recharge request for PKR ${pkrAmount.toLocaleString()} submitted! Admin will process it shortly.`, 'success'); 
                    this.state.ui.rechargeForm.reset(); 
                    this.state.ui.rechargeStep1Form.reset();
                    this.hideModal('recharge-modal'); 
                } catch (err) { 
                    this.showToast(`Request failed: ${err.message}`, 'danger'); 
                } finally { 
                    this.setButtonLoading(btn, false); 
                } 
            },

            // MODIFIED handleWithdraw for PKR - Sets status to 'pending'
            async handleWithdraw(e) { 
                e.preventDefault(); 
                const btn = e.currentTarget.querySelector('button'); 
                const pkrAmount = parseFloat(document.getElementById('withdraw-amount').value); 
                const network = document.getElementById('withdraw-network').value;
                const accountNumber = document.getElementById('withdraw-account-number').value.trim();
                const accountHolderName = document.getElementById('withdraw-account-holder-name').value.trim();
                
                if (isNaN(pkrAmount) || pkrAmount <= 0 || !accountNumber || !network || !accountHolderName) {
                    return this.showToast('Please fill all fields.', 'danger'); 
                }
                if (!/^\d{11}$/.test(accountNumber)) {
                    return this.showToast('Account Number must be 11 digits.', 'danger'); 
                }

                const fee = pkrAmount * this.config.WITHDRAWAL_FEE_PERCENT;
                const netPkrWithdrawal = pkrAmount + fee; // The amount to deduct from balance

                if (this.state.userData.pkr_balance < netPkrWithdrawal) {
                    return this.showToast(`Insufficient balance. Required PKR: ${netPkrWithdrawal.toLocaleString()}.`, 'danger'); 
                }
                
                this.setButtonLoading(btn, true); 
                
                try { 
                    // Move funds to balance_on_hold immediately
                    await this.state.userRef.update({ 
                        pkr_balance: firebase.database.ServerValue.increment(-netPkrWithdrawal), 
                        balance_on_hold: firebase.database.ServerValue.increment(netPkrWithdrawal) 
                    }); 
                    
                    await this.db.ref('withdrawal_requests').push({ 
                        userId: this.state.currentUser.uid, 
                        userEmail: this.state.currentUser.email, 
                        pkrAmount: pkrAmount,
                        fee: fee, 
                        network, 
                        accountNumber, 
                        accountHolderName,
                        status: 'pending', 
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    }); 

                    // Log transaction with pending status for history view
                    await this.logTransaction('withdrawal', pkrAmount, { 
                        network, 
                        accountNumber, 
                        accountHolderName,
                        fee, 
                        status: 'pending' 
                    }); 

                    this.showToast(`Withdrawal request for PKR ${pkrAmount.toLocaleString()} submitted! Admin will process it shortly.`, 'success'); 
                    this.state.ui.withdrawalForm.reset(); 
                    this.hideModal('withdrawal-modal'); 
                } catch (err) { 
                    this.showToast(`Withdrawal failed: ${err.message}`, 'danger'); 
                    // Rollback on client-side failure (return funds from hold to balance)
                    await this.state.userRef.update({ 
                        pkr_balance: firebase.database.ServerValue.increment(netPkrWithdrawal), 
                        balance_on_hold: firebase.database.ServerValue.increment(-netPkrWithdrawal) 
                    });
                } finally { 
                    this.setButtonLoading(btn, false); 
                } 
            },
            
            // --- [5.1] Plan & Invitation Bonus Logic (Modified for PKR) ---
            
            updatePlansUI() {
                const container = this.state.ui.marketingPlansContainer;
                container.innerHTML = ''; 
                
                // Basic Plan
                const basicCard = document.createElement('div');
                basicCard.className = 'plan-card';
                basicCard.innerHTML = `
                    <div class="plan-visual" style="box-shadow: 0 0 15px var(--primary-accent); background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent));">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h4>Basic Plan</h4>
                    <p class="plan-price">PKR ${this.config.BASIC_PLAN_COST.toLocaleString()}</p>
                    <ul class="nft-details" style="border-left: 5px solid var(--primary-accent);">
                        <li><span>Daily Earning</span><span>0%</span></li>
                        <li><span>Invitation Rewards</span><span>Yes</span></li>
                        <li><span>Duration</span><span>Lifetime</span></li>
                    </ul>
                    <button class="btn btn-purchase-plan" data-plan-id="basic" data-plan-cost="${this.config.BASIC_PLAN_COST}" style="border-radius: 14px;">
                        <span class="btn-text">Purchase Plan</span>
                    </button>
                `;
                container.appendChild(basicCard);
                
                // Pro Plan
                const proCard = document.createElement('div');
                proCard.className = 'plan-card';
                proCard.innerHTML = `
                    <div class="plan-visual" style="box-shadow: 0 0 15px var(--danger-color); background: linear-gradient(45deg, var(--danger-color), #f87171);">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h4>Pro Earning Plan</h4>
                    <p class="plan-price">PKR ${this.config.PRO_PLAN_COST.toLocaleString()}</p>
                    <ul class="nft-details" style="border-left: 5px solid var(--danger-color);">
                        <li><span>Daily Earning</span><span>1%</span></li>
                        <li><span>Invitation Rewards</span><span>Yes</span></li>
                        <li><span>Duration</span><span>Lifetime</span></li>
                    </ul>
                    <button class="btn btn-purchase-plan" data-plan-id="pro" data-plan-cost="${this.config.PRO_PLAN_COST}" style="background: linear-gradient(45deg, var(--danger-color), #f87171); border-radius: 14px;">
                        <span class="btn-text">Purchase Plan</span>
                    </button>
                `;
                container.appendChild(proCard);
            },

            // NEW: Direct plan purchase
            async handleDirectPlanPurchase(planId) {
                const planCost = planId === 'basic' ? this.config.BASIC_PLAN_COST : this.config.PRO_PLAN_COST;
                const planName = planId === 'basic' ? 'Basic Plan' : 'Pro Earning Plan';
                
                const pkr_balance = this.state.userData.pkr_balance || 0;

                // Pre-check for balance before purchase
                if (planCost > pkr_balance) { 
                    return this.showToast('Insufficient PKR balance to purchase this plan. Please recharge.', 'danger');
                }
                
                try {
                    const plansData = this.state.userData.plans || {};
                    const isFirstInvestment = !(plansData.firstInvestmentProcessed); // For bonus gating
                    
                    const updates = {
                        'pkr_balance': firebase.database.ServerValue.increment(-planCost), 
                        'plans/totalInvestmentPKR': firebase.database.ServerValue.increment(planCost),
                        'plans/lastProfitClaimTimestamp': firebase.database.ServerValue.TIMESTAMP,
                        'active_plan': planName
                    };

                    await this.state.userRef.update(updates);
                    
                    // Must be called AFTER the investment is successfully processed
                    if (isFirstInvestment) { 
                        // **This is the logic that gates the invitation bonus earning and activates referrals**
                        await this.processFirstInvestmentAndReferrals(planCost); 
                    }
                    
                    await this.logTransaction('plan_invest', planCost, { reason: `Purchased ${planName}`, status: 'approved' });
                    this.showToast(`Successfully purchased ${planName} for PKR ${planCost.toLocaleString()}!`, 'success');
                } catch (error) { 
                    this.showToast(`Error: ${error.message}`, 'danger');
                }
            },
            
            // NEW/MODIFIED: Logic for processing a user's first investment (to activate referral earning for ancestors)
            async processFirstInvestmentAndReferrals(investmentAmount) {
                const userUid = this.state.currentUser.uid;
                const userData = this.state.userData;
                const ancestry = userData.ancestry || {};
                const updates = {};
                
                // 1. Mark user as having completed their first investment to unlock *their* bonus earning
                updates[`/users/${userUid}/plans/firstInvestmentProcessed`] = true;

                // 2. Distribute bonuses to ancestors and mark downlines as 'active'
                for (let i = 1; i <= this.config.REFERRAL_LEVELS; i++) {
                    const ancestorUid = ancestry[`level_${i}`];
                    if (!ancestorUid) break; 
                    
                    const isDirect = i === 1; // Ancestor at level 1 is the direct referrer
                    const bonusRate = isDirect ? this.config.REFERRAL_DIRECT_BONUS_PERCENT : this.config.REFERRAL_INDIRECT_BONUS_PERCENT;
                    const bonusAmount = investmentAmount * bonusRate;
                    
                    // Increment the ancestor's unclaimed bonus
                    updates[`/users/${ancestorUid}/unclaimed_invite_bonus`] = firebase.database.ServerValue.increment(bonusAmount);

                    // Log the bonus transaction on the ancestor's side
                    // Note: We cannot use logTransaction here as it's a batch update. We'll simulate a log.
                    await this.db.ref(`transactions/${ancestorUid}`).push({
                        type: 'invite_bonus',
                        amount: bonusAmount,
                        details: { 
                            reason: `Referral Bonus L${i} from ${userData.username || this.maskEmail(userData.email)}'s first investment`,
                            referredUserUid: userUid,
                            status: 'approved'
                        },
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });

                    // Update ancestor's active referral count (only on the direct referrer)
                    if (isDirect) {
                        // Mark the direct referrer's active_referrals_count and miningGateProgress
                        updates[`/users/${ancestorUid}/active_referrals_count`] = firebase.database.ServerValue.increment(1);
                        updates[`/users/${ancestorUid}/miningGateProgress/activatedReferralsCount`] = firebase.database.ServerValue.increment(1);
                        updates[`/users/${ancestorUid}/miningGateProgress/activatedReferralUIDs/${userUid}`] = true;
                    }
                }

                // 3. Commit all updates
                await this.db.ref().update(updates);
            },
            
            // MODIFIED: Only Pro Plan earns daily profit (1%), Basic Plan has 0%
            getEffectiveDailyRate() {
                const activePlan = this.state.userData?.active_plan;
                
                if (!activePlan) {
                    return 0;
                }

                // Pro Plan gives 1% daily
                if (activePlan === 'Pro Earning Plan') {
                    return this.config.PRO_PLAN_DAILY_RATE; // 0.01
                }

                // Basic Plan has 0% earning
                return 0; 
            },
            
            async handleClaimPlanProfit(e) {
                const btn = e.currentTarget;
                const profitPKR = this.calculatePlanProfit(); 
                
                if (profitPKR < this.config.MINIMUM_PROFIT_CLAIM) {
                    return this.showToast("Profit is too low to claim.", "info");
                }
                this.setButtonLoading(btn, true);
                try {
                    await this.state.userRef.transaction(data => {
                        if (data && data.plans) {
                            data.pkr_balance = (data.pkr_balance || 0) + profitPKR; 
                            data.plans.lastProfitClaimTimestamp = firebase.database.ServerValue.TIMESTAMP;
                            data.plans.totalProfitGeneratedPKR = (data.plans.totalProfitGeneratedPKR || 0) + profitPKR;
                        }
                        return data;
                    });
                    await this.logTransaction('plan_profit', profitPKR, { status: 'approved' });
                    this.showToast(`Claimed PKR ${profitPKR.toLocaleString()}!`, 'success');
                } catch(error) {
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            calculatePlanProfit(planData = this.state.userData?.plans) {
                if (!planData?.totalInvestmentPKR || !planData.lastProfitClaimTimestamp) return 0;
                
                const effectiveDailyRate = this.getEffectiveDailyRate();
                if (effectiveDailyRate === 0) return 0; // User is not in an earning state

                const elapsedMs = Date.now() - planData.lastProfitClaimTimestamp;
                if (elapsedMs <= 0) return 0;
                
                const potentialProfitPKR = (elapsedMs / 86400000) * (planData.totalInvestmentPKR * effectiveDailyRate);
                
                return potentialProfitPKR;
            },

            // NEW: Enhanced Active Plan UI
            updatePlanUI() {
                if(this.state.planProfitInterval) clearInterval(this.state.planProfitInterval);
                const planData = this.state.userData?.plans;
                const activePlan = this.state.userData?.active_plan;
                
                if (activePlan) {
                    this.state.ui.activePlanDisplay.style.display = 'block';
                    
                    const investment = planData.totalInvestmentPKR;
                    const effectiveDailyRate = this.getEffectiveDailyRate();

                    let rateText;
                    let dailyProfitValue = investment * effectiveDailyRate;

                    if (effectiveDailyRate === this.config.PRO_PLAN_DAILY_RATE) {
                        rateText = `PKR ${dailyProfitValue.toLocaleString()} (1% Daily)`;
                    } else {
                        // Basic Plan has 0% daily earning
                        rateText = `PKR 0 (0%)`;
                    }

                    // Update enhanced active plan UI
                    this.state.ui.activePlanName.textContent = activePlan;
                    this.state.ui.activePlanInvestment.textContent = `PKR ${investment.toLocaleString()}`;
                    this.state.ui.activePlanDailyProfit.textContent = rateText;

                    this.state.planProfitInterval = setInterval(() => {
                        const accumulatedProfit = this.calculatePlanProfit(); 
                        this.state.ui.activePlanAccumulated.textContent = `PKR ${accumulatedProfit.toLocaleString()}`;
                        
                        // Update progress bar
                        const progressPercent = Math.min((accumulatedProfit / (investment * 0.5)) * 100, 100); // Cap at 100%
                        this.state.ui.activePlanProgressText.textContent = `${Math.round(progressPercent)}%`;
                        this.state.ui.activePlanProgressBar.style.width = `${progressPercent}%`;
                        
                        // Update claim button state
                        this.state.ui.claimPlanProfitBtn.disabled = accumulatedProfit < dailyProfitValue; // Only allow claim after 1 day's profit is generated
                        this.state.ui.claimPlanProfitBtn.querySelector('.btn-text').innerHTML = `<i class="fas fa-hand-holding-dollar"></i> Claim Profit`;
                        
                        // Update next claim time
                        const timeSinceLastClaim = Date.now() - planData.lastProfitClaimTimestamp;
                        const twentyFourHours = 24 * 60 * 60 * 1000;
                        if (timeSinceLastClaim >= twentyFourHours) {
                            this.state.ui.activePlanNextClaim.textContent = 'Ready';
                            this.state.ui.activePlanNextClaim.style.color = 'var(--success-color)';
                        } else {
                            const remaining = twentyFourHours - timeSinceLastClaim;
                            const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                            const minutes = Math.floor((remaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                            this.state.ui.activePlanNextClaim.textContent = `${hours}:${minutes}`;
                            this.state.ui.activePlanNextClaim.style.color = 'var(--warning-color)';
                        }
                        
                        if (effectiveDailyRate === 0) { // Override: If no profit, keep button disabled
                            this.state.ui.claimPlanProfitBtn.disabled = true;
                            this.state.ui.claimPlanProfitBtn.querySelector('.btn-text').innerHTML = `No Daily Earning`;
                        }
                    }, 1000);

                } else {
                    this.state.ui.activePlanDisplay.style.display = 'none';
                }
            },

            // --- [5.2] Ranking Logic (Modified for PKR) ---
            calculateUserNetWorth(userData) {
                const pkrBalance = userData.pkr_balance || 0;
                const planInvestment = userData.plans?.totalInvestmentPKR || 0;
                const planProfit = userData.plans?.totalProfitGeneratedPKR || 0;
                let nftValue = 0;
                if (userData.nfts) {
                    Object.values(userData.nfts).forEach(nft => {
                        nftValue += (nft.investment || 0) + (nft.totalProfitClaimed || 0);
                    });
                }
                const netWorth = pkrBalance + planInvestment + planProfit + nftValue;
                return netWorth;
            },
            
            // MODIFIED: Simple Rank Display
            getRankDisplay(rank) {
                if (rank <= 0) return 'N/A';
                return `#${rank}`;
            },

            updateRankingUI() {
                const rankedUsers = this.state.allUsersData;
                const rankingList = this.state.ui.rankingList;
                const currentUserUid = this.state.currentUser?.uid;
                
                rankingList.innerHTML = '';
                if (rankedUsers.length === 0) {
                    rankingList.innerHTML = '<p class="info-text" id="no-ranking-msg">No ranking data available yet. Start investing to see your rank!</p>';
                    return;
                }

                const topUsers = rankedUsers.slice(0, this.config.RANKING_LIMIT);
                
                // Hide the "No data" message
                document.getElementById('no-ranking-msg')?.remove();

                topUsers.forEach((user, index) => {
                    const rank = index + 1;
                    const isCurrentUser = user.uid === currentUserUid;
                    const item = document.createElement('li');
                    item.className = 'ranking-item';
                    if (isCurrentUser) item.style.borderLeftColor = 'var(--primary-accent)';
                    if (rank <= 3) item.style.background = 'var(--surface-highlight)';
                    
                    const rankDisplay = this.getRankDisplay(rank);
                    const rankClass = rank <= 3 ? 'top-3' : ''; 

                    const usernameDisplay = user.username || this.maskEmail(user.email);

                    item.innerHTML = `
                        <div class="rank-num ${rankClass}">${rankDisplay}</div>
                        <div class="user-info" style="width: 40%;">
                            <div class="username">${usernameDisplay} ${isCurrentUser ? '(You)' : ''}</div>
                            <div class="uid">${user.uid.slice(0, 8)}...</div>
                        </div>
                        <div class="net-worth" style="width: 45%;">PKR ${user.netWorth.toLocaleString()}</div>
                    `;
                    rankingList.appendChild(item);
                });

                if (this.state.userData && currentUserUid) {
                    const myRankIndex = rankedUsers.findIndex(u => u.uid === currentUserUid);
                    const myNetWorth = this.calculateUserNetWorth(this.state.userData);
                    this.state.ui.myNetWorthValue.textContent = `PKR ${myNetWorth.toLocaleString()}`;
                    this.state.ui.myGlobalRankValue.textContent = myRankIndex !== -1 ? `${myRankIndex + 1} / ${rankedUsers.length}` : 'N/A';
                    this.state.ui.myGlobalRankValue.style.color = myRankIndex !== -1 && myRankIndex < 10 ? 'var(--tertiary-accent)' : 'var(--warning-color)';
                }
            },
            
            // --- [5.3] Profile, Tasks, Rewards & Network Logic ---
            
            async handleChangePassword(e) { e.preventDefault(); const btn = e.target.querySelector('button'); this.setButtonLoading(btn, true); const currentPassword = document.getElementById('current-password').value; const newPassword = document.getElementById('new-password').value; if (newPassword.length < 6) { this.showToast('New password must be at least 6 characters.', 'danger'); this.setButtonLoading(btn, false); return; } try { const user = this.state.currentUser; await user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, currentPassword)); await user.updatePassword(newPassword); this.showToast('Password changed successfully!', 'success'); this.state.ui.changePasswordForm.reset(); this.showPage('profile-page'); } catch (error) { this.showToast(error.message, 'danger'); } finally { this.setButtonLoading(btn, false); } },
            // Log transaction with status detail
            async logTransaction(type, amount, details = {}) { if(!this.state.currentUser) return; await this.db.ref(`transactions/${this.state.currentUser.uid}`).push({ type, amount, details, timestamp: firebase.database.ServerValue.TIMESTAMP }); },

            // REPLACED: Function to update the referral bonus UI AND render the new hexagon network
            updateNetworkUI() {
                const unclaimedBonus = this.state.userData.unclaimed_invite_bonus || 0;
                const isPlanPurchased = this.state.userData.plans?.firstInvestmentProcessed === true; // The key check
                
                this.state.ui.unclaimedBonusAmount.textContent = `PKR ${unclaimedBonus.toLocaleString()}`;
                this.state.ui.collectBonusBtn.disabled = unclaimedBonus <= 0;
                
                // --- NEW LOCK/UNLOCK UI LOGIC ---
                const inviteBox = document.querySelector('#invite-page .content-panel.invite-box');
                const networkPanel = document.querySelector('#hexagon-network-container').closest('.content-panel');
                
                if (inviteBox && networkPanel) {
                    const lockIcon = `<i class="fas ${isPlanPurchased ? 'fa-lock-open' : 'fa-lock'}"></i>`;
                    const lockColor = isPlanPurchased ? 'var(--success-color)' : 'var(--danger-color)';
                    const lockText = isPlanPurchased ? 'Your Referral System is UNLOCKED!' : 'Referral System is LOCKED!';
                    const instructions = isPlanPurchased 
                        ? 'Share your link to start earning commissions immediately from your direct and indirect network.'
                        : 'You must purchase an Earning Plan (Basic or Pro) to activate your referral system and start earning commissions.';

                    let lockPanel = inviteBox.parentNode.querySelector('#referral-lock-status');
                    if (!lockPanel) {
                        lockPanel = document.createElement('div');
                        lockPanel.id = 'referral-lock-status';
                        lockPanel.className = 'content-panel invite-box';
                        // Insert before the original invite code box
                        inviteBox.parentNode.insertBefore(lockPanel, inviteBox);
                    }
                    
                    lockPanel.style.marginTop = '0'; // Adjust spacing
                    lockPanel.style.marginBottom = '25px';
                    lockPanel.style.border = `2px solid ${lockColor}`;
                    lockPanel.style.boxShadow = `0 0 15px ${lockColor.replace('var(--', 'rgba(').replace(')', ', 0.5)')}`;

                    lockPanel.innerHTML = `
                        <div class="icon" style="color: ${lockColor}; text-shadow: 0 0 20px ${lockColor.replace('var(--', 'rgba(').replace(')', ', 0.5)')};">
                            ${lockIcon}
                        </div>
                        <h3 style="background: none; -webkit-text-fill-color: ${lockColor}; border-bottom: none; margin-bottom: 5px;">${lockText}</h3>
                        <p>${instructions}</p>
                    `;
                    
                    // Hide/Show network map based on plan purchase
                    networkPanel.style.opacity = isPlanPurchased ? '1' : '0.4';
                    networkPanel.style.pointerEvents = isPlanPurchased ? 'auto' : 'none';
                }
                // --- END NEW LOCK/UNLOCK UI LOGIC ---

                this.renderHexagonNetwork();
            },

            // REPLACED: Renders the dynamic hexagon network structure
            renderHexagonNetwork() {
                const container = this.state.ui.hexagonNetworkContainer;
                const referralsData = this.state.userData.referrals_data || {};
                container.innerHTML = ''; // Clear previous render

                // Always add the "YOU" node
                container.innerHTML += `
                    <div class="hexagon you-node">
                        <div class="hexagon-inner">
                            <i class="fas fa-crown"></i>
                            <span>YOU</span>
                        </div>
                    </div>
                `;

                if (Object.keys(referralsData).length === 0) {
                     container.innerHTML += '<p class="info-text" style="text-align: center; margin-top: 30px;">Your network map will appear here after your first referral joins and invests.</p>';
                     return;
                }
                
                const totalLevels = this.config.REFERRAL_LEVELS + 1; // 1 Direct + 9 Indirect
                for (let i = 1; i <= totalLevels; i++) {
                    const levelKey = `level_${i}`;
                    const levelData = referralsData[levelKey];
                    
                    const levelDiv = document.createElement('div');
                    levelDiv.className = 'level';
                    levelDiv.dataset.level = i;

                    if (levelData) {
                        Object.values(levelData).forEach(user => {
                            const usernameDisplay = user.username || this.maskEmail(user.email);
                            const joinedDate = new Date(user.joinedAt).toLocaleDateString();
                            const tooltip = `User: ${usernameDisplay} | Joined: ${joinedDate}`;
                            
                            const userNode = document.createElement('div');
                            userNode.className = 'hexagon user-node';
                            userNode.dataset.tooltip = tooltip;
                            userNode.innerHTML = `
                                <div class="hexagon-inner">
                                    <i class="fas fa-user-astronaut"></i>
                                    <span>${usernameDisplay}</span>
                                </div>
                            `;
                            levelDiv.appendChild(userNode);
                        });
                    }
                    container.appendChild(levelDiv);
                }
            },

            async handleCollectInviteBonus(e) {
                const btn = e.currentTarget;
                const unclaimedBonus = this.state.userData.unclaimed_invite_bonus || 0;
                if (unclaimedBonus <= 0) return;
                this.setButtonLoading(btn, true);
                try {
                    await this.state.userRef.update({
                        pkr_balance: firebase.database.ServerValue.increment(unclaimedBonus),
                        unclaimed_invite_bonus: 0
                    });
                    // Log transaction with approved status
                    await this.logTransaction('invite_bonus', unclaimedBonus, { reason: 'Network Commission', status: 'approved' }); 
                    this.showToast(`Collected PKR ${unclaimedBonus.toLocaleString()} from your network!`, 'success');
                } catch (error) {
                    this.showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },
            
            // UPDATED FREE MINING UI LOGIC
            updateFreeMiningUI() {
                const activeReferrals = this.state.userData.active_referrals_count || 0;
                this.state.ui.freeMiningProgress.textContent = `${activeReferrals} / ${this.config.FREE_PLAN_REQUIRED_REFERRALS}`;
            },
            
            // --- [5.4] NFT Logic (Modified for PKR) ---
            
            canUserBuyNFT() {
                return (this.state.userData.active_referrals_count || 0) >= this.config.NFT_REQUIRED_ACTIVE_REFERRALS;
            },

            updateNFTRequirementUI() {
                const canBuy = this.canUserBuyNFT();
                const activeRefs = this.state.userData.active_referrals_count || 0;
                const requiredRefs = this.config.NFT_REQUIRED_ACTIVE_REFERRALS;
                const panel = this.state.ui.nftRequirementPanel;
                const grid = this.state.ui.nftGridContainer;
                
                panel.innerHTML = `
                    <div class="invite-box">
                        <div class="icon" style="color: ${canBuy ? 'var(--success-color)' : 'var(--danger-color)'}; text-shadow: 0 0 20px ${canBuy ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'};">
                            <i class="fas ${canBuy ? 'fa-lock-open' : 'fa-lock'}"></i>
                        </div>
                        <h3 style="background: none; -webkit-text-fill-color: ${canBuy ? 'var(--success-color)' : 'var(--danger-color)'}; border-bottom: none;">NFT Access Status: ${canBuy ? 'UNLOCKED' : 'LOCKED'}</h3>
                        <p>Requirement: To purchase any NFT, you must have <b>${requiredRefs} direct members</b> who have made their first investment.</p>
                        <div class="stat-card" style="margin: 20px 0;">
                            <div class="label">Your Active Direct Referrals</div>
                            <div class="value" style="color: ${canBuy ? 'var(--success-color)' : 'var(--warning-color)'};">${activeRefs} / ${requiredRefs}</div>
                        </div>
                    </div>
                `;
                
                // Disable/Enable the grid and buttons
                grid.style.opacity = canBuy ? '1' : '0.4';
                grid.style.pointerEvents = canBuy ? 'auto' : 'none';
                
                document.querySelectorAll('.btn-buy-nft').forEach(btn => {
                    btn.disabled = !canBuy;
                    btn.querySelector('.btn-text').textContent = canBuy ? 'Buy Now' : 'Locked';
                });
            },

            async handleBuyNft(btn) {
                const { nftId, min, max } = btn.dataset;
                const card = btn.closest('.nft-card');
                const amountInput = card.querySelector('.nft-buy-amount');
                const amount = parseFloat(amountInput.value);

                if (!this.canUserBuyNFT()) {
                     this.setButtonLoading(btn, false);
                     return this.showToast(`NFT purchase is locked. You need ${this.config.NFT_REQUIRED_ACTIVE_REFERRALS} active direct members.`, 'danger');
                }

                if (isNaN(amount)) return this.showToast('Please enter a valid amount.', 'danger');
                if (amount < min || amount > max) return this.showToast(`Amount must be between PKR ${min.toLocaleString()} and PKR ${max.toLocaleString()}.`, 'danger');
                if (amount > (this.state.userData.pkr_balance || 0)) return this.showToast('Insufficient PKR balance.', 'danger');
                
                this.setButtonLoading(btn, true);
                try {
                    await this.state.userRef.child('pkr_balance').set(firebase.database.ServerValue.increment(-amount));
                    await this.state.userRef.child('nfts').push({
                        nftId: nftId,
                        investment: amount,
                        purchaseTimestamp: firebase.database.ServerValue.TIMESTAMP,
                        lastClaimTimestamp: firebase.database.ServerValue.TIMESTAMP,
                        totalProfitClaimed: 0,
                    });
                    // Log NFT purchase with approved status
                    await this.logTransaction('nft_purchase', amount, { reason: `${nftId.charAt(0).toUpperCase() + nftId.slice(1)} NFT`, status: 'approved' });
                    this.showToast(`Successfully purchased ${nftId} NFT!`, 'success');
                    amountInput.value = '';
                } catch (error) {
                    this.showToast(`Purchase failed: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            updateMyNftsUI() {
                Object.values(this.state.nftIntervals).forEach(clearInterval);
                this.state.nftIntervals = {};
                const userNfts = this.state.userData?.nfts || {};
                const nftKeys = Object.keys(userNfts);

                if (nftKeys.length === 0) {
                    this.state.ui.myNftsList.innerHTML = '';
                    this.state.ui.noNftsMsg.style.display = 'block';
                    return;
                }

                this.state.ui.noNftsMsg.style.display = 'none';
                this.state.ui.myNftsList.innerHTML = '';

                nftKeys.forEach(key => {
                    const nft = userNfts[key];
                    const nftNames = { bronze: 'Bronze Miner', silver: 'Silver Prospector', gold: 'Gold Titan' };
                    const cardColors = { bronze: '#cd7f32', silver: '#c0c0c0', gold: '#FFC300' };

                    const card = document.createElement('div');
                    card.className = 'my-nft-card';
                    card.style.borderLeftColor = cardColors[nft.nftId] || 'var(--primary-accent)';
                    card.innerHTML = `
                        <div class="my-nft-card-header">
                            <h4>${nftNames[nft.nftId] || 'NFT'}</h4>
                            <span class="investment" style="color: ${cardColors[nft.nftId]}">PKR ${nft.investment.toLocaleString()}</span>
                        </div>
                        <div class="nft-profit-details">
                            <div>
                                <div class="label">Total Claimed</div>
                                <div class="value" id="claimed-${key}">PKR ${nft.totalProfitClaimed.toLocaleString()}</div>
                            </div>
                             <div>
                                <div class="label">Claimable Now</div>
                                <div class="value" id="claimable-${key}" style="color: var(--success-color);">...</div>
                            </div>
                        </div>
                         <div class="nft-timer" id="timer-${key}">Calculating...</div>
                         <div>
                            <div class="label">Total Return Progress (300%)</div>
                            <div class="nft-progress-bar">
                                <div class="nft-progress-bar-inner" id="progress-${key}" style="width: 0%;"></div>
                            </div>
                        </div>
                        <button class="btn btn-claim btn-claim-nft full-width" data-nft-key="${key}" disabled style="border-radius: 14px;">
                            <span class="btn-text">Claim Profit</span>
                            <div class="spinner-sm"></div>
                        </button>`;
                    this.state.ui.myNftsList.appendChild(card);
                    this.state.nftIntervals[key] = setInterval(() => this.updateSingleNftCard(key), 1000);
                });
            },

            updateSingleNftCard(key) {
                const nft = this.state.userData?.nfts?.[key];
                if (!nft) {
                    clearInterval(this.state.nftIntervals[key]);
                    return;
                }

                const claimableEl = document.getElementById(`claimable-${key}`);
                const timerEl = document.getElementById(`timer-${key}`);
                const progressEl = document.getElementById(`progress-${key}`);
                const claimBtn = document.querySelector(`.btn-claim-nft[data-nft-key="${key}"]`);

                if (!claimableEl || !timerEl || !progressEl || !claimBtn) {
                     clearInterval(this.state.nftIntervals[key]);
                     return;
                }

                const dailyProfit = nft.investment * this.config.NFT_DAILY_RATE_PERCENT;
                const totalReturnCap = nft.investment * this.config.NFT_TOTAL_RETURN_PERCENT;
                
                if (nft.totalProfitClaimed >= totalReturnCap) {
                    claimableEl.textContent = 'PKR 0';
                    timerEl.textContent = 'Completed (300% Return Achieved)';
                    timerEl.style.color = 'var(--success-color)';
                    claimBtn.disabled = true;
                    claimBtn.querySelector('.btn-text').textContent = 'Completed';
                    progressEl.style.width = '100%';
                    clearInterval(this.state.nftIntervals[key]);
                    return;
                }

                const now = Date.now();
                const lastClaim = nft.lastClaimTimestamp;
                const timeSinceLastClaim = now - lastClaim;
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                let claimableAmount = (timeSinceLastClaim / twentyFourHours) * dailyProfit;
                claimableAmount = Math.min(claimableAmount, dailyProfit);
                claimableAmount = Math.min(claimableAmount, totalReturnCap - nft.totalProfitClaimed);
                
                claimableEl.textContent = `PKR ${claimableAmount.toLocaleString()}`;
                const progressPercent = (nft.totalProfitClaimed / totalReturnCap) * 100;
                progressEl.style.width = `${progressPercent}%`;

                if (timeSinceLastClaim >= twentyFourHours) {
                    timerEl.textContent = 'Ready to Claim!';
                    timerEl.style.color = 'var(--success-color)';
                    claimBtn.disabled = false;
                } else {
                    const remaining = twentyFourHours - timeSinceLastClaim;
                    const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                    const minutes = Math.floor((remaining / (1000 * 60)) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((remaining / 1000) % 60).toString().padStart(2, '0');
                    timerEl.textContent = `Next claim in: ${hours}:${minutes}:${seconds}`;
                    timerEl.style.color = 'var(--warning-color)';
                    claimBtn.disabled = true;
                }
            },

            async handleClaimNftProfit(nftKey, btn) {
                const nft = this.state.userData?.nfts?.[nftKey];
                if (!nft) return this.showToast('NFT not found.', 'danger');

                const now = Date.now();
                const timeSinceLastClaim = now - nft.lastClaimTimestamp;
                const twentyFourHours = 24 * 60 * 60 * 1000;

                if (timeSinceLastClaim < twentyFourHours) {
                    return this.showToast('Not yet time to claim.', 'info');
                }
                
                this.setButtonLoading(btn, true);

                try {
                    const dailyProfit = nft.investment * this.config.NFT_DAILY_RATE_PERCENT;
                    const totalReturnCap = nft.investment * this.config.NFT_TOTAL_RETURN_PERCENT;
                    let profitToClaim = dailyProfit;

                    if (nft.totalProfitClaimed + profitToClaim > totalReturnCap) {
                        profitToClaim = totalReturnCap - nft.totalProfitClaimed;
                    }

                    if (profitToClaim <= 0) {
                        this.showToast('No profit left to claim.', 'info');
                        this.setButtonLoading(btn, false);
                        return;
                    }
                    
                    const updates = {};
                    updates[`/users/${this.state.currentUser.uid}/pkr_balance`] = firebase.database.ServerValue.increment(profitToClaim);
                    updates[`/users/${this.state.currentUser.uid}/nfts/${nftKey}/totalProfitClaimed`] = firebase.database.ServerValue.increment(profitToClaim);
                    updates[`/users/${this.state.currentUser.uid}/nfts/${nftKey}/lastClaimTimestamp`] = firebase.database.ServerValue.TIMESTAMP;
                    
                    await this.db.ref().update(updates);
                    // Log NFT profit with approved status
                    await this.logTransaction('nft_profit', profitToClaim, { reason: `${nft.nftId} NFT Earning`, status: 'approved' });
                    
                    this.showToast(`Claimed PKR ${profitToClaim.toLocaleString()}!`, 'success');

                } catch (error) {
                    this.showToast(`Claim failed: ${error.message}`, 'danger');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            // --- [6] DATA LISTENERS ---
            listenToUserData() { 
                if (!this.state.currentUser || this.state.userRef) return; 
                this.state.userRef = this.db.ref('users/' + this.state.currentUser.uid); 
                this.state.txRef = this.db.ref('transactions/' + this.state.currentUser.uid); 
                this.state.userRef.on('value', (snapshot) => { 
                    this.hidePreloader(); 
                    this.state.userData = snapshot.val(); 
                    if (this.state.userData) { 
                        this.updateUI(); 
                    } else { 
                        this.auth.signOut(); 
                    } 
                }, (error) => { 
                    console.error("Firebase user data error:", error); 
                    this.showToast("Could not sync user data.", "danger"); 
                }); 
                // Listen to the user's transactions for the history page, updated by admin changes to status
                this.state.txRef.limitToLast(100).on('value', (snapshot) => this.updateAllHistories(snapshot.val())); 
            },

            stopAllListeners() { 
                if (this.state.userRef) this.state.userRef.off(); 
                if (this.state.txRef) this.state.txRef.off(); 
                if(this.state.planProfitInterval) clearInterval(this.state.planProfitInterval); 
                if(this.state.carouselInterval) clearInterval(this.state.carouselInterval); // Stop carousel
                Object.values(this.state.nftIntervals).forEach(clearInterval); 
                this.state.nftIntervals = {}; 
                this.state.userRef = null; 
                this.state.txRef = null; 
            },

            // --- [7] HELPERS ---
            copyToClipboard(textToCopy, elementToUpdate = null, customMessage = 'Copied!') { 
                if (!textToCopy) return; 
                navigator.clipboard.writeText(textToCopy).then(() => { 
                    this.showToast(customMessage, 'success'); 
                    if (elementToUpdate) { 
                        // Specific handler for the address box
                        if(elementToUpdate.classList.contains('address-box')) { 
                            const icon = elementToUpdate.querySelector('.copy-btn i'); 
                            const originalIconClass = icon.className; 
                            elementToUpdate.classList.add('copied'); 
                            icon.className = 'fas fa-check'; 
                            setTimeout(() => { 
                                elementToUpdate.classList.remove('copied'); 
                                icon.className = originalIconClass; 
                            }, 2500); 
                        } else { 
                            // General button handler
                            const originalHTML = elementToUpdate.innerHTML; 
                            elementToUpdate.innerHTML = `<i class="fas fa-check"></i> <span>Copied!</span>`; 
                            elementToUpdate.disabled = true; 
                            setTimeout(() => { 
                                elementToUpdate.innerHTML = originalHTML; 
                                elementToUpdate.disabled = false; 
                            }, 2000); 
                        } 
                    } 
                }).catch(() => this.showToast('Failed to copy.', 'danger')); 
            },
            initDraggableFAB() { const fab = this.state.ui.telegramFab; if (!fab) return; let isDragging = false, hasMoved = false, offsetX, offsetY; const getCoords = e => e.touches ? e.touches[0] : e; const start = e => { isDragging = true; hasMoved = false; fab.classList.add('dragging'); const c = getCoords(e); offsetX = c.clientX - fab.offsetLeft; offsetY = c.clientY - fab.offsetTop; document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, { passive: false }); document.addEventListener('mouseup', end); document.addEventListener('touchend', end); }; const move = e => { if (!isDragging) return; e.preventDefault(); hasMoved = true; const c = getCoords(e); fab.style.left = `${Math.max(0, Math.min(c.clientX - offsetX, window.innerWidth - fab.offsetWidth))}px`; fab.style.top = `${Math.max(0, Math.min(c.clientY - offsetY, window.innerHeight - fab.offsetHeight))}px`; fab.style.right = 'auto'; fab.style.bottom = 'auto'; }; const end = () => { isDragging = false; fab.classList.remove('dragging'); document.removeEventListener('mousemove', move); document.removeEventListener('touchmove', move); document.removeEventListener('mouseup', end); document.removeEventListener('touchend', end); }; fab.addEventListener('mousedown', start); fab.addEventListener('touchstart', start); fab.addEventListener('click', e => { if (hasMoved) e.preventDefault(); }); },
            maskEmail(email) {
                if (!email || email.indexOf('@') === -1) return email;
                const [name, domain] = email.split('@');
                if (name.length <= 2) return `${name.slice(0, 1)}***@${domain}`;
                return `${name.slice(0, 2)}***@${domain}`;
            },
        };

        window.App = App;
        App.init();
    });
    </script>
</body>
</html>